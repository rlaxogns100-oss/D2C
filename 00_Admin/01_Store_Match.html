<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§¤ì¥ ë§¤ì¹­ ê´€ë¦¬ - D2C Admin</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* ë¹„ë°€ë²ˆí˜¸ ì¸ì¦ ëª¨ë‹¬ */
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .auth-modal {
            background: white;
            border-radius: 16px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        .auth-modal h2 {
            font-size: 24px;
            margin-bottom: 8px;
            color: #1F2937;
        }
        
        .auth-modal p {
            color: #6B7280;
            margin-bottom: 24px;
        }
        
        .auth-modal input {
            width: 100%;
            padding: 14px;
            font-size: 18px;
            text-align: center;
            border: 2px solid #E5E7EB;
            border-radius: 8px;
            margin-bottom: 16px;
            letter-spacing: 4px;
        }
        
        .auth-modal input:focus {
            outline: none;
            border-color: #4F46E5;
        }
        
        .auth-modal button {
            width: 100%;
            padding: 14px;
            font-size: 16px;
            font-weight: 600;
            background: #4F46E5;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .auth-modal button:hover {
            background: #4338CA;
        }
        
        .auth-error {
            color: #EF4444;
            font-size: 14px;
            margin-top: 12px;
            display: none;
        }
        
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- ë¹„ë°€ë²ˆí˜¸ ì¸ì¦ ëª¨ë‹¬ -->
    <div class="auth-overlay" id="authOverlay">
        <div class="auth-modal">
            <h2>ğŸ” ê´€ë¦¬ì ì¸ì¦</h2>
            <p>ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
            <input type="password" id="authPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" maxlength="10" onkeyup="if(event.key==='Enter') checkAuth()">
            <button onclick="checkAuth()">í™•ì¸</button>
            <div class="auth-error" id="authError">ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤</div>
        </div>
    </div>

    <!-- Header -->
    <div class="header hidden" id="mainContent">
        <div class="header-content">
            <div class="logo">ğŸª ë§¤ì¥ ë§¤ì¹­ ê´€ë¦¬</div>
            <a href="index.html" class="btn btn-secondary btn-sm">â† ëŒ€ì‹œë³´ë“œ</a>
        </div>
    </div>

    <div class="container hidden" id="containerContent">
        <!-- ë§¤ì¥ ì—†ëŠ” OWNER ëª©ë¡ -->
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">ğŸ‘¥ ë§¤ì¥ ì—†ëŠ” OWNER ëª©ë¡</h2>
                <button class="btn btn-secondary btn-sm" onclick="loadUsersWithoutStore()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
            </div>
            <table class="table">
                <thead>
                    <tr>
                        <th>User ID</th>
                        <th>ì´ë©”ì¼</th>
                        <th>ì´ë¦„</th>
                        <th>ê°€ì…ì¼</th>
                        <th>ì•¡ì…˜</th>
                    </tr>
                </thead>
                <tbody id="usersTable">
                    <tr>
                        <td colspan="5" class="empty-state">
                            <div class="empty-icon">ğŸ“­</div>
                            <div>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- ì „ì²´ ë§¤ì¥ ëª©ë¡ -->
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">ğŸª ì „ì²´ ë§¤ì¥ ëª©ë¡</h2>
                <button class="btn btn-secondary btn-sm" onclick="loadAllStores()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
            </div>
            <table class="table">
                <thead>
                    <tr>
                        <th>Store ID</th>
                        <th>ì„œë¸Œë„ë©”ì¸</th>
                        <th>ë§¤ì¥ëª…</th>
                        <th>Owner ID</th>
                        <th>ìƒíƒœ</th>
                        <th>ì•¡ì…˜</th>
                    </tr>
                </thead>
                <tbody id="storesTable">
                    <tr>
                        <td colspan="6" class="empty-state">
                            <div class="empty-icon">ğŸ“­</div>
                            <div>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- ë§¤ì¥ ìƒì„± ëª¨ë‹¬ -->
    <div class="modal-overlay" id="createModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">ğŸª ìƒˆ ë§¤ì¥ ìƒì„±</h3>
            </div>
            <form onsubmit="return createStore(event)">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">ğŸ‘¤ ì ì£¼ ì •ë³´</label>
                        <div style="background: #F3F4F6; padding: 12px; border-radius: 8px; font-size: 14px;">
                            <div><strong>User ID:</strong> <span id="modalUserId"></span></div>
                            <div><strong>ì´ë©”ì¼:</strong> <span id="modalEmail"></span></div>
                            <div><strong>ì´ë¦„:</strong> <span id="modalName"></span></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="storeName">ë§¤ì¥ëª… *</label>
                        <input type="text" id="storeName" class="form-input" placeholder="ì¹˜í‚¨í‚¹" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="subdomain">ì„œë¸Œë„ë©”ì¸ *</label>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <input 
                                type="text" 
                                id="subdomain" 
                                class="form-input" 
                                placeholder="chickenking" 
                                pattern="[a-z0-9-]+"
                                style="flex: 1;"
                                required
                            >
                            <span style="color: #6B7280;">.maejang.com</span>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="checkSubdomain()">ì¤‘ë³µí™•ì¸</button>
                        </div>
                        <div class="form-hint" id="subdomainMsg">ì˜ë¬¸ ì†Œë¬¸ì, ìˆ«ì, í•˜ì´í”ˆ(-)ë§Œ ì‚¬ìš© ê°€ëŠ¥</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="address">ì£¼ì†Œ *</label>
                        <input type="text" id="address" class="form-input" placeholder="ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 123" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="description">ì„¤ëª… (ì„ íƒ)</label>
                        <textarea id="description" class="form-input" rows="3" placeholder="ë§¤ì¥ ì†Œê°œ"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-success">ìƒì„±</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const ADMIN_PASSWORD = '235811';
        const API_BASE = '';
        let currentUserId = null;
        let subdomainChecked = false;

        // ì¸ì¦ í™•ì¸
        function checkAuth() {
            const password = document.getElementById('authPassword').value;
            
            if (password === ADMIN_PASSWORD) {
                sessionStorage.setItem('adminAuth', 'true');
                document.getElementById('authOverlay').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                document.getElementById('containerContent').classList.remove('hidden');
                loadUsersWithoutStore();
                loadAllStores();
            } else {
                document.getElementById('authError').style.display = 'block';
                document.getElementById('authPassword').value = '';
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¸ì¦ ìƒíƒœ í™•ì¸
        window.addEventListener('DOMContentLoaded', () => {
            if (sessionStorage.getItem('adminAuth') === 'true') {
                document.getElementById('authOverlay').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                document.getElementById('containerContent').classList.remove('hidden');
                loadUsersWithoutStore();
                loadAllStores();
            }
            
            document.getElementById('authPassword').focus();
        });

        // ë§¤ì¥ ì—†ëŠ” ìœ ì € ëª©ë¡ ë¡œë“œ
        async function loadUsersWithoutStore() {
            try {
                const response = await fetch(`${API_BASE}/api/v1/admin/users/without-store`, {
                    headers: { 'X-Admin-Password': ADMIN_PASSWORD }
                });

                if (!response.ok) throw new Error('Failed to load users');

                const result = await response.json();
                const users = result.data || [];

                const tbody = document.getElementById('usersTable');
                
                if (users.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="empty-state">
                                <div class="empty-icon">âœ…</div>
                                <div>ëª¨ë“  OWNERì—ê²Œ ë§¤ì¥ì´ ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤!</div>
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = users.map(user => `
                    <tr>
                        <td>${user.userId}</td>
                        <td>${user.email}</td>
                        <td>${user.name || '-'}</td>
                        <td>${user.createdAt ? new Date(user.createdAt).toLocaleDateString() : '-'}</td>
                        <td>
                            <button class="btn btn-success btn-sm" onclick="openCreateModal(${user.userId}, '${user.email}', '${user.name || ''}')">
                                ë§¤ì¥ ìƒì„±
                            </button>
                        </td>
                    </tr>
                `).join('');

            } catch (error) {
                console.error('ìœ ì € ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('usersTable').innerHTML = `
                    <tr>
                        <td colspan="5" class="empty-state">
                            <div class="empty-icon">âŒ</div>
                            <div>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>
                        </td>
                    </tr>
                `;
            }
        }

        // ì „ì²´ ë§¤ì¥ ëª©ë¡ ë¡œë“œ
        async function loadAllStores() {
            try {
                const response = await fetch(`${API_BASE}/api/v1/admin/stores`, {
                    headers: { 'X-Admin-Password': ADMIN_PASSWORD }
                });

                if (!response.ok) throw new Error('Failed to load stores');

                const result = await response.json();
                const stores = result.data || [];

                const tbody = document.getElementById('storesTable');
                
                if (stores.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="empty-state">
                                <div class="empty-icon">ğŸ“­</div>
                                <div>ë“±ë¡ëœ ë§¤ì¥ì´ ì—†ìŠµë‹ˆë‹¤</div>
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = stores.map(store => {
                    const isDeprecated = store.subdomain && store.subdomain.includes('deprecated');
                    const statusBadge = isDeprecated 
                        ? '<span class="badge badge-inactive">ë¹„í™œì„±</span>'
                        : '<span class="badge badge-active">í™œì„±</span>';
                    
                    const subdomainCell = store.subdomain && !isDeprecated
                        ? `<a href="https://${store.subdomain}.maejang.com" target="_blank" style="color: #4F46E5; text-decoration: none;">${store.subdomain}.maejang.com</a>`
                        : (store.subdomain || '<span style="color:#9CA3AF;">ë¯¸ì„¤ì •</span>');
                    
                    return `
                        <tr>
                            <td>${store.storeId}</td>
                            <td>${subdomainCell}</td>
                            <td>${store.storeName}</td>
                            <td>${store.ownerId || '-'}</td>
                            <td>${statusBadge}</td>
                            <td>
                                <button class="btn btn-secondary btn-sm" onclick="location.href='store_detail.html?id=${store.storeId}'">ìƒì„¸</button>
                            </td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error('ë§¤ì¥ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('storesTable').innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            <div class="empty-icon">âŒ</div>
                            <div>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>
                        </td>
                    </tr>
                `;
            }
        }

        // ë§¤ì¥ ìƒì„± ëª¨ë‹¬ ì—´ê¸°
        function openCreateModal(userId, email, name) {
            currentUserId = userId;
            subdomainChecked = false;
            
            document.getElementById('modalUserId').textContent = userId;
            document.getElementById('modalEmail').textContent = email;
            document.getElementById('modalName').textContent = name || '(ì—†ìŒ)';
            
            document.getElementById('storeName').value = '';
            document.getElementById('subdomain').value = '';
            document.getElementById('address').value = '';
            document.getElementById('description').value = '';
            document.getElementById('subdomainMsg').textContent = 'ì˜ë¬¸ ì†Œë¬¸ì, ìˆ«ì, í•˜ì´í”ˆ(-)ë§Œ ì‚¬ìš© ê°€ëŠ¥';
            document.getElementById('subdomainMsg').className = 'form-hint';
            
            document.getElementById('createModal').classList.add('active');
        }

        // ëª¨ë‹¬ ë‹«ê¸°
        function closeModal() {
            document.getElementById('createModal').classList.remove('active');
        }

        // ì„œë¸Œë„ë©”ì¸ ì¤‘ë³µ í™•ì¸
        async function checkSubdomain() {
            const subdomain = document.getElementById('subdomain').value.trim().toLowerCase();
            const msgEl = document.getElementById('subdomainMsg');
            
            if (!subdomain) {
                msgEl.textContent = 'ì„œë¸Œë„ë©”ì¸ì„ ì…ë ¥í•˜ì„¸ìš”';
                msgEl.className = 'form-hint form-error';
                return;
            }

            if (!/^[a-z0-9-]+$/.test(subdomain)) {
                msgEl.textContent = 'ì˜ë¬¸ ì†Œë¬¸ì, ìˆ«ì, í•˜ì´í”ˆ(-)ë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤';
                msgEl.className = 'form-hint form-error';
                return;
            }

            if (subdomain.length < 3 || subdomain.length > 20) {
                msgEl.textContent = '3~20ì ì‚¬ì´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”';
                msgEl.className = 'form-hint form-error';
                return;
            }

            // ì˜ˆì•½ì–´ ì²´í¬
            const reserved = ['www', 'admin', 'api', 'mail', 'ftp', 'app', 'dev', 'test', 'db', 'cdn', 'maejang', 'owner'];
            if (reserved.includes(subdomain)) {
                msgEl.textContent = 'ì‚¬ìš©í•  ìˆ˜ ì—†ëŠ” ë„ë©”ì¸ì…ë‹ˆë‹¤ (ì˜ˆì•½ì–´)';
                msgEl.className = 'form-hint form-error';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/v1/store/check-subdomain?subdomain=${subdomain}`);
                const result = await response.json();

                if (result.data === true) {
                    msgEl.textContent = 'âœ“ ì‚¬ìš© ê°€ëŠ¥í•œ ë„ë©”ì¸ì…ë‹ˆë‹¤!';
                    msgEl.className = 'form-hint form-success';
                    subdomainChecked = true;
                } else {
                    msgEl.textContent = 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë„ë©”ì¸ì…ë‹ˆë‹¤';
                    msgEl.className = 'form-hint form-error';
                    subdomainChecked = false;
                }
            } catch (error) {
                msgEl.textContent = 'í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤';
                msgEl.className = 'form-hint form-error';
            }
        }

        // ë§¤ì¥ ìƒì„±
        async function createStore(event) {
            event.preventDefault();

            if (!subdomainChecked) {
                alert('ì„œë¸Œë„ë©”ì¸ ì¤‘ë³µ í™•ì¸ì„ í•´ì£¼ì„¸ìš”');
                return false;
            }

            const subdomain = document.getElementById('subdomain').value.trim().toLowerCase();
            const data = {
                userId: currentUserId,
                subdomain: subdomain,
                storeName: document.getElementById('storeName').value.trim(),
                address: document.getElementById('address').value.trim(),
                description: document.getElementById('description').value.trim()
            };

            try {
                const response = await fetch(`${API_BASE}/api/v1/admin/store/create`, {
                    method: 'POST',
                    headers: {
                        'X-Admin-Password': ADMIN_PASSWORD,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || 'Failed to create store');
                }

                const result = await response.json();
                
                alert(`âœ… ë§¤ì¥ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!\n\në§¤ì¥ ì£¼ì†Œ: https://${subdomain}.maejang.com\n\nâš ï¸ ì¤‘ìš”: ì„œë²„ì˜ Caddyfileì— ì´ ë„ë©”ì¸ì„ ì¶”ê°€í•´ì•¼ ì ‘ì†ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.`);
                
                closeModal();
                loadUsersWithoutStore();
                loadAllStores();

            } catch (error) {
                console.error('ë§¤ì¥ ìƒì„± ì‹¤íŒ¨:', error);
                alert('ë§¤ì¥ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }

            return false;
        }

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document.getElementById('createModal').addEventListener('click', (e) => {
            if (e.target.id === 'createModal') {
                closeModal();
            }
        });
    </script>
</body>
</html>
