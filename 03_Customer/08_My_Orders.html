<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>08 My Orders</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="screen-label">주문 내역</div>
  
  <div class="container">
    <!-- Header -->
    <div class="orders-header">
      <button class="icon-btn back-btn" style="position: static;" onclick="history.back()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M15 18l-6-6 6-6"/>
        </svg>
      </button>
      <h2>주문 내역</h2>
      <button class="icon-btn menu-btn" style="position: static;" onclick="location.href='04_Home.html'">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="5" r="1.5" fill="currentColor"/>
          <circle cx="12" cy="12" r="1.5" fill="currentColor"/>
          <circle cx="12" cy="19" r="1.5" fill="currentColor"/>
        </svg>
      </button>
    </div>
    
    <!-- Tabs -->
    <div class="orders-tabs">
      <button class="orders-tab active" onclick="switchTab('ongoing')">진행 중</button>
      <button class="orders-tab" onclick="switchTab('history')">지난 주문</button>
    </div>
    
    <!-- Ongoing Tab Content -->
    <div id="ongoing-content" class="tab-content">
      <!-- Category Label -->
      <p style="font-size: 14px; font-weight: 600; margin-bottom: 16px;">음식</p>
      
      <!-- Order Cards (Ongoing) -->
      <div class="order-card">
        <div class="order-header">
          <div class="order-image"></div>
          <div class="order-info">
            <h4>Burger Bistro</h4>
            <p class="order-price">$64.00</p>
            <p class="order-items">2개</p>
          </div>
        </div>
        <p class="order-id">#162435 | 배송 중</p>
        <div class="order-actions">
          <button class="btn-primary" onclick="alert('주문 추적 기능은 준비중입니다')">주문 추적</button>
          <button class="btn-outline" onclick="if(confirm('주문을 취소하시겠습니까?')) alert('주문이 취소되었습니다')">취소</button>
        </div>
      </div>
      
      <p style="font-size: 14px; font-weight: 600; margin-bottom: 16px;">음식</p>
      
      <div class="order-card">
        <div class="order-header">
          <div class="order-image"></div>
          <div class="order-info">
            <h4>Pizza Hut</h4>
            <p class="order-price">$35.25</p>
            <p class="order-items">3개</p>
          </div>
        </div>
        <p class="order-id">#162434 | 준비 중</p>
        <div class="order-actions">
          <button class="btn-primary" onclick="alert('주문 추적 기능은 준비중입니다')">주문 추적</button>
          <button class="btn-outline" onclick="if(confirm('주문을 취소하시겠습니까?')) alert('주문이 취소되었습니다')">취소</button>
        </div>
      </div>
    </div>
    
    <!-- History Tab Content -->
    <div id="history-content" class="tab-content" style="display: none;">
      <!-- Category Label -->
      <p style="font-size: 14px; font-weight: 600; margin-bottom: 16px;">음식</p>
      
      <!-- Order Cards (History) -->
      <div class="order-card">
        <div class="order-header">
          <div class="order-image"></div>
          <div class="order-info">
            <h4>Spicy Restaurant</h4>
            <p class="order-price">$80.00</p>
            <p class="order-items">4개</p>
          </div>
        </div>
        <p class="order-id">#162400 | 배송 완료 (12/10)</p>
        <div class="order-actions">
          <button class="btn-primary" onclick="alert('다시 주문하기 기능은 준비중입니다')">다시 주문</button>
          <button class="btn-outline" onclick="alert('영수증 보기 기능은 준비중입니다')">영수증</button>
        </div>
      </div>
      
      <p style="font-size: 14px; font-weight: 600; margin-bottom: 16px;">음식</p>
      
      <div class="order-card">
        <div class="order-header">
          <div class="order-image"></div>
          <div class="order-info">
            <h4>Pizza Hut</h4>
            <p class="order-price">$35.25</p>
            <p class="order-items">3개</p>
          </div>
        </div>
        <p class="order-id">#162380 | 배송 완료 (12/05)</p>
        <div class="order-actions">
          <button class="btn-primary" onclick="alert('다시 주문하기 기능은 준비중입니다')">다시 주문</button>
          <button class="btn-outline" onclick="alert('영수증 보기 기능은 준비중입니다')">영수증</button>
        </div>
      </div>
      
      <p style="font-size: 14px; font-weight: 600; margin-bottom: 16px;">음식</p>
      
      <div class="order-card">
        <div class="order-header">
          <div class="order-image"></div>
          <div class="order-info">
            <h4>Burger Ferguson</h4>
            <p class="order-price">$40.00</p>
            <p class="order-items">1개</p>
          </div>
        </div>
        <p class="order-id">#162350 | 배송 완료 (12/01)</p>
        <div class="order-actions">
          <button class="btn-primary" onclick="alert('다시 주문하기 기능은 준비중입니다')">다시 주문</button>
          <button class="btn-outline" onclick="alert('영수증 보기 기능은 준비중입니다')">영수증</button>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // baseUrl 처리 (로컬 파일 테스트용)
    const baseUrl = window.location.protocol === 'file:' 
      ? 'https://pizzaschool.maejang.com'
      : '';

    let allOrders = [];

    // 페이지 로드 시 주문 불러오기
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('[My Orders] Page loaded');
      
      // JWT 토큰 확인
      const token = localStorage.getItem('accessToken');
      if (!token) {
        alert('로그인이 필요합니다.');
        location.href = '02_Login.html';
        return;
      }

      try {
        // 주문 내역 API 호출
        const response = await fetch(`${baseUrl}/api/v1/order/history`, {
          method: 'GET',
          credentials: 'include',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          throw new Error('주문 내역을 불러올 수 없습니다.');
        }

        const data = await response.json();
        console.log('[My Orders] Orders:', data);

        if (data.success && data.data) {
          allOrders = data.data;
          loadOrders();
        }

      } catch (error) {
        console.error('[My Orders] Error:', error);
        alert('주문 내역을 불러오는데 실패했습니다: ' + error.message);
      }
    });
    
    // 주문 로드 (현재 탭에 맞게)
    function loadOrders() {
      // 진행 중인 주문: ORDERED, COOKING
      const ongoingOrders = allOrders.filter(order => 
        order.condition === 'ORDERED' || order.condition === 'COOKING'
      );
      
      // 완료된 주문: COMPLETED, CANCELLED, REJECTED
      const historyOrders = allOrders.filter(order => 
        order.condition === 'COMPLETED' || order.condition === 'CANCELLED' || order.condition === 'REJECTED'
      );
      
      // Ongoing 탭 렌더링
      const ongoingContent = document.getElementById('ongoing-content');
      if (ongoingOrders.length > 0) {
        ongoingContent.innerHTML = ongoingOrders.map(order => renderOrder(order, true)).join('');
      } else {
        ongoingContent.innerHTML = '<p style="text-align: center; padding: 40px; color: var(--text-gray);">진행중인 주문이 없습니다</p>';
      }
      
      // History 탭 렌더링
      const historyContent = document.getElementById('history-content');
      if (historyOrders.length > 0) {
        historyContent.innerHTML = historyOrders.map(order => renderOrder(order, false)).join('');
      } else {
        historyContent.innerHTML = '<p style="text-align: center; padding: 40px; color: var(--text-gray);">주문 내역이 없습니다</p>';
      }
    }
    
    // 주문 상태 텍스트 변환
    function getOrderStatusText(condition) {
      const statusMap = {
        'ORDERED': '주문 접수',
        'COOKING': '조리 중',
        'COMPLETED': '배송 완료',
        'CANCELLED': '취소됨',
        'REJECTED': '거절됨'
      };
      return statusMap[condition] || condition;
    }

    // 주문 카드 렌더링
    function renderOrder(order, isOngoing) {
      const date = new Date(order.orderAt).toLocaleDateString('ko-KR', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
      });
      
      const statusText = getOrderStatusText(order.condition);
      
      return `
        <p style="font-size: 14px; font-weight: 600; margin-bottom: 16px;">음식</p>
        <div class="order-card">
          <div class="order-header">
            <div class="order-image"></div>
            <div class="order-info">
              <h4>주문 #${order.id}</h4>
              <p class="order-price">${order.price.toLocaleString()}원</p>
              <p class="order-items">${order.request || '요청사항 없음'}</p>
            </div>
          </div>
          <p class="order-id">#${order.id} | ${isOngoing ? statusText : statusText + ' (' + date + ')'}</p>
          <div class="order-actions">
            ${isOngoing ? `
              <button class="btn-primary" onclick="alert('주문 추적 기능은 준비중입니다')">주문 추적</button>
              <button class="btn-outline" onclick="cancelOrder(${order.id})">취소</button>
            ` : `
              <button class="btn-primary" onclick="alert('다시 주문하기 기능은 준비중입니다')">다시 주문</button>
              <button class="btn-outline" onclick="alert('영수증 보기 기능은 준비중입니다')">영수증</button>
            `}
          </div>
        </div>
      `;
    }
    
    // 주문 취소
    async function cancelOrder(orderId) {
      if (!confirm('주문을 취소하시겠습니까?')) {
        return;
      }

      const token = localStorage.getItem('accessToken');
      if (!token) {
        alert('로그인이 필요합니다.');
        location.href = '02_Login.html';
        return;
      }

      try {
        const response = await fetch(`${baseUrl}/api/v1/order/delete?orderId=${orderId}`, {
          method: 'DELETE',
          credentials: 'include',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        const result = await response.json();

        if (response.ok && result.success) {
          alert('주문이 취소되었습니다.');
          
          // 주문 목록 다시 불러오기
          const historyResponse = await fetch(`${baseUrl}/api/v1/order/history`, {
            method: 'GET',
            credentials: 'include',
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });

          if (historyResponse.ok) {
            const historyData = await historyResponse.json();
            if (historyData.success && historyData.data) {
              allOrders = historyData.data;
              loadOrders();
            }
          }
        } else {
          throw new Error(result.message || '주문 취소에 실패했습니다.');
        }

      } catch (error) {
        console.error('[My Orders] Cancel error:', error);
        alert('주문 취소 실패: ' + error.message);
      }
    }
    
    // 탭 전환 기능
    function switchTab(tabName) {
      // 모든 탭 버튼의 active 클래스 제거
      document.querySelectorAll('.orders-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // 클릭한 탭 버튼에 active 클래스 추가
      event.target.classList.add('active');
      
      // 모든 탭 콘텐츠 숨기기
      document.querySelectorAll('.tab-content').forEach(content => {
        content.style.display = 'none';
      });
      
      // 선택한 탭 콘텐츠만 보이기
      document.getElementById(tabName + '-content').style.display = 'block';
    }
  </script>
</body>
</html>
