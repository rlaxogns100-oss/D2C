<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>08 My Orders</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="screen-label">ì£¼ë¬¸ ë‚´ì—­</div>
  
  <div class="container">
    <!-- Header -->
    <div class="orders-header">
      <button class="icon-btn back-btn" style="position: static;" onclick="history.back()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M15 18l-6-6 6-6"/>
        </svg>
      </button>
      <h2>ì£¼ë¬¸ ë‚´ì—­</h2>
      <button class="icon-btn menu-btn" style="position: static;" onclick="location.href='04_Home.html'">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="5" r="1.5" fill="currentColor"/>
          <circle cx="12" cy="12" r="1.5" fill="currentColor"/>
          <circle cx="12" cy="19" r="1.5" fill="currentColor"/>
        </svg>
      </button>
    </div>
    
    <!-- Tabs -->
    <div class="orders-tabs">
      <button class="orders-tab active" onclick="switchTab('ongoing')">ì§„í–‰ ì¤‘</button>
      <button class="orders-tab" onclick="switchTab('history')">ì§€ë‚œ ì£¼ë¬¸</button>
    </div>
    
    <!-- Ongoing Tab Content -->
    <div id="ongoing-content" class="tab-content">
      <!-- Category Label -->
      <p style="font-size: 14px; font-weight: 600; margin-bottom: 16px;">ìŒì‹</p>
      
      <!-- Order Cards (Ongoing) -->
      <div class="order-card">
        <div class="order-header">
          <div class="order-image"></div>
          <div class="order-info">
            <h4>Burger Bistro</h4>
            <p class="order-price">$64.00</p>
            <p class="order-items">2ê°œ</p>
          </div>
        </div>
        <p class="order-id">#162435 | ë°°ì†¡ ì¤‘</p>
        <div class="order-actions">
          <button class="btn-primary" onclick="alert('ì£¼ë¬¸ ì¶”ì  ê¸°ëŠ¥ì€ ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤')">ì£¼ë¬¸ ì¶”ì </button>
          <button class="btn-outline" onclick="if(confirm('ì£¼ë¬¸ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) alert('ì£¼ë¬¸ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤')">ì·¨ì†Œ</button>
        </div>
      </div>
      
      <p style="font-size: 14px; font-weight: 600; margin-bottom: 16px;">ìŒì‹</p>
      
      <div class="order-card">
        <div class="order-header">
          <div class="order-image"></div>
          <div class="order-info">
            <h4>Pizza Hut</h4>
            <p class="order-price">$35.25</p>
            <p class="order-items">3ê°œ</p>
          </div>
        </div>
        <p class="order-id">#162434 | ì¤€ë¹„ ì¤‘</p>
        <div class="order-actions">
          <button class="btn-primary" onclick="alert('ì£¼ë¬¸ ì¶”ì  ê¸°ëŠ¥ì€ ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤')">ì£¼ë¬¸ ì¶”ì </button>
          <button class="btn-outline" onclick="if(confirm('ì£¼ë¬¸ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) alert('ì£¼ë¬¸ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤')">ì·¨ì†Œ</button>
        </div>
      </div>
    </div>
    
    <!-- History Tab Content -->
    <div id="history-content" class="tab-content" style="display: none;">
      <!-- Category Label -->
      <p style="font-size: 14px; font-weight: 600; margin-bottom: 16px;">ìŒì‹</p>
      
      <!-- Order Cards (History) -->
      <div class="order-card">
        <div class="order-header">
          <div class="order-image"></div>
          <div class="order-info">
            <h4>Spicy Restaurant</h4>
            <p class="order-price">$80.00</p>
            <p class="order-items">4ê°œ</p>
          </div>
        </div>
        <p class="order-id">#162400 | ë°°ì†¡ ì™„ë£Œ (12/10)</p>
        <div class="order-actions">
          <button class="btn-primary" onclick="alert('ë‹¤ì‹œ ì£¼ë¬¸í•˜ê¸° ê¸°ëŠ¥ì€ ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤')">ë‹¤ì‹œ ì£¼ë¬¸</button>
          <button class="btn-outline" onclick="alert('ì˜ìˆ˜ì¦ ë³´ê¸° ê¸°ëŠ¥ì€ ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤')">ì˜ìˆ˜ì¦</button>
        </div>
      </div>
      
      <p style="font-size: 14px; font-weight: 600; margin-bottom: 16px;">ìŒì‹</p>
      
      <div class="order-card">
        <div class="order-header">
          <div class="order-image"></div>
          <div class="order-info">
            <h4>Pizza Hut</h4>
            <p class="order-price">$35.25</p>
            <p class="order-items">3ê°œ</p>
          </div>
        </div>
        <p class="order-id">#162380 | ë°°ì†¡ ì™„ë£Œ (12/05)</p>
        <div class="order-actions">
          <button class="btn-primary" onclick="alert('ë‹¤ì‹œ ì£¼ë¬¸í•˜ê¸° ê¸°ëŠ¥ì€ ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤')">ë‹¤ì‹œ ì£¼ë¬¸</button>
          <button class="btn-outline" onclick="alert('ì˜ìˆ˜ì¦ ë³´ê¸° ê¸°ëŠ¥ì€ ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤')">ì˜ìˆ˜ì¦</button>
        </div>
      </div>
      
      <p style="font-size: 14px; font-weight: 600; margin-bottom: 16px;">ìŒì‹</p>
      
      <div class="order-card">
        <div class="order-header">
          <div class="order-image"></div>
          <div class="order-info">
            <h4>Burger Ferguson</h4>
            <p class="order-price">$40.00</p>
            <p class="order-items">1ê°œ</p>
          </div>
        </div>
        <p class="order-id">#162350 | ë°°ì†¡ ì™„ë£Œ (12/01)</p>
        <div class="order-actions">
          <button class="btn-primary" onclick="alert('ë‹¤ì‹œ ì£¼ë¬¸í•˜ê¸° ê¸°ëŠ¥ì€ ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤')">ë‹¤ì‹œ ì£¼ë¬¸</button>
          <button class="btn-outline" onclick="alert('ì˜ìˆ˜ì¦ ë³´ê¸° ê¸°ëŠ¥ì€ ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤')">ì˜ìˆ˜ì¦</button>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // baseUrl ì²˜ë¦¬ (ë¡œì»¬ íŒŒì¼ í…ŒìŠ¤íŠ¸ìš©)
    const baseUrl = window.location.protocol === 'file:' 
      ? 'https://pizzaschool.maejang.com'
      : '';

    let allOrders = [];

    // ğŸ” ë¡œê·¸ì¸ ë§Œë£Œ ì²´í¬ ë° ìë™ ë¦¬ë‹¤ì´ë ‰íŠ¸
    function checkAuthError(response) {
      if (response.status === 401 || response.status === 403) {
        alert('ë¡œê·¸ì¸ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
        localStorage.removeItem('accessToken');
        location.href = '02_Login.html';
        return true;
      }
      return false;
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì£¼ë¬¸ ë¶ˆëŸ¬ì˜¤ê¸°
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('[My Orders] Page loaded');
      
      // JWT í† í° í™•ì¸
      const token = localStorage.getItem('accessToken');
      if (!token) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        location.href = '02_Login.html';
        return;
      }

      try {
        // ì£¼ë¬¸ ë‚´ì—­ API í˜¸ì¶œ
        const response = await fetch(`${baseUrl}/api/v1/order/history`, {
          method: 'GET',
          credentials: 'include',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (checkAuthError(response)) return;

        if (!response.ok) {
          throw new Error('ì£¼ë¬¸ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }

        const data = await response.json();
        console.log('[My Orders] Orders:', data);

        if (data.success && data.data) {
          allOrders = data.data;
          loadOrders();
        }

      } catch (error) {
        console.error('[My Orders] Error:', error);
        alert('ì£¼ë¬¸ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
      }
    });
    
    // ì£¼ë¬¸ ë¡œë“œ (í˜„ì¬ íƒ­ì— ë§ê²Œ)
    function loadOrders() {
      // ì§„í–‰ ì¤‘ì¸ ì£¼ë¬¸: ORDERED, COOKING
      const ongoingOrders = allOrders.filter(order => 
        order.condition === 'ORDERED' || order.condition === 'COOKING'
      );
      
      // ì™„ë£Œëœ ì£¼ë¬¸: COMPLETED, CANCELLED, REJECTED
      const historyOrders = allOrders.filter(order => 
        order.condition === 'COMPLETED' || order.condition === 'CANCELLED' || order.condition === 'REJECTED'
      );
      
      // Ongoing íƒ­ ë Œë”ë§
      const ongoingContent = document.getElementById('ongoing-content');
      if (ongoingOrders.length > 0) {
        ongoingContent.innerHTML = ongoingOrders.map(order => renderOrder(order, true)).join('');
      } else {
        ongoingContent.innerHTML = '<p style="text-align: center; padding: 40px; color: var(--text-gray);">ì§„í–‰ì¤‘ì¸ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤</p>';
      }
      
      // History íƒ­ ë Œë”ë§
      const historyContent = document.getElementById('history-content');
      if (historyOrders.length > 0) {
        historyContent.innerHTML = historyOrders.map(order => renderOrder(order, false)).join('');
      } else {
        historyContent.innerHTML = '<p style="text-align: center; padding: 40px; color: var(--text-gray);">ì£¼ë¬¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</p>';
      }
    }
    
    // ì£¼ë¬¸ ìƒíƒœ í…ìŠ¤íŠ¸ ë³€í™˜
    function getOrderStatusText(condition) {
      const statusMap = {
        'ORDERED': 'ì£¼ë¬¸ ì ‘ìˆ˜',
        'COOKING': 'ì¡°ë¦¬ ì¤‘',
        'COMPLETED': 'ë°°ì†¡ ì™„ë£Œ',
        'CANCELLED': 'ì·¨ì†Œë¨',
        'REJECTED': 'ê±°ì ˆë¨'
      };
      return statusMap[condition] || condition;
    }

    // ì£¼ë¬¸ ì¹´ë“œ ë Œë”ë§
    function renderOrder(order, isOngoing) {
      const date = new Date(order.orderAt).toLocaleDateString('ko-KR', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
      });
      
      const statusText = getOrderStatusText(order.condition);
      
      return `
        <p style="font-size: 14px; font-weight: 600; margin-bottom: 16px;">ìŒì‹</p>
        <div class="order-card">
          <div class="order-header">
            <div class="order-image"></div>
            <div class="order-info">
              <h4>ì£¼ë¬¸ #${order.id}</h4>
              <p class="order-price">${order.price.toLocaleString()}ì›</p>
              <p class="order-items">${order.request || 'ìš”ì²­ì‚¬í•­ ì—†ìŒ'}</p>
            </div>
          </div>
          <p class="order-id">#${order.id} | ${isOngoing ? statusText : statusText + ' (' + date + ')'}</p>
          <div class="order-actions">
            ${isOngoing ? `
              <button class="btn-primary" onclick="alert('ì£¼ë¬¸ ì¶”ì  ê¸°ëŠ¥ì€ ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤')">ì£¼ë¬¸ ì¶”ì </button>
              <button class="btn-outline" onclick="cancelOrder(${order.id})">ì·¨ì†Œ</button>
            ` : `
              <button class="btn-primary" onclick="alert('ë‹¤ì‹œ ì£¼ë¬¸í•˜ê¸° ê¸°ëŠ¥ì€ ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤')">ë‹¤ì‹œ ì£¼ë¬¸</button>
              <button class="btn-outline" onclick="alert('ì˜ìˆ˜ì¦ ë³´ê¸° ê¸°ëŠ¥ì€ ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤')">ì˜ìˆ˜ì¦</button>
            `}
          </div>
        </div>
      `;
    }
    
    // ì£¼ë¬¸ ì·¨ì†Œ
    async function cancelOrder(orderId) {
      if (!confirm('ì£¼ë¬¸ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }

      const token = localStorage.getItem('accessToken');
      if (!token) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        location.href = '02_Login.html';
        return;
      }

      try {
        const response = await fetch(`${baseUrl}/api/v1/order/delete?orderId=${orderId}`, {
          method: 'DELETE',
          credentials: 'include',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (checkAuthError(response)) return;

        const result = await response.json();

        if (response.ok && result.success) {
          alert('ì£¼ë¬¸ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
          
          // ì£¼ë¬¸ ëª©ë¡ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
          const historyResponse = await fetch(`${baseUrl}/api/v1/order/history`, {
            method: 'GET',
            credentials: 'include',
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });

          if (historyResponse.ok) {
            const historyData = await historyResponse.json();
            if (historyData.success && historyData.data) {
              allOrders = historyData.data;
              loadOrders();
            }
          }
        } else {
          throw new Error(result.message || 'ì£¼ë¬¸ ì·¨ì†Œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }

      } catch (error) {
        console.error('[My Orders] Cancel error:', error);
        alert('ì£¼ë¬¸ ì·¨ì†Œ ì‹¤íŒ¨: ' + error.message);
      }
    }
    
    // íƒ­ ì „í™˜ ê¸°ëŠ¥
    function switchTab(tabName) {
      // ëª¨ë“  íƒ­ ë²„íŠ¼ì˜ active í´ë˜ìŠ¤ ì œê±°
      document.querySelectorAll('.orders-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // í´ë¦­í•œ íƒ­ ë²„íŠ¼ì— active í´ë˜ìŠ¤ ì¶”ê°€
      event.target.classList.add('active');
      
      // ëª¨ë“  íƒ­ ì½˜í…ì¸  ìˆ¨ê¸°ê¸°
      document.querySelectorAll('.tab-content').forEach(content => {
        content.style.display = 'none';
      });
      
      // ì„ íƒí•œ íƒ­ ì½˜í…ì¸ ë§Œ ë³´ì´ê¸°
      document.getElementById(tabName + '-content').style.display = 'block';
    }
  </script>
</body>
</html>
