<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ï£ºÎ¨∏ ÎÇ¥Ïó≠</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="screen-label">Ï£ºÎ¨∏ ÎÇ¥Ïó≠</div>
  
  <div class="container">
    <!-- Header -->
    <div class="orders-header">
      <button class="icon-btn back-btn" style="position: static;" onclick="history.back()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M15 18l-6-6 6-6"/>
        </svg>
      </button>
      <h2>Ï£ºÎ¨∏ ÎÇ¥Ïó≠</h2>
      <button class="icon-btn menu-btn" style="position: static;" onclick="location.href='04_Home.html'">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="5" r="1.5" fill="currentColor"/>
          <circle cx="12" cy="12" r="1.5" fill="currentColor"/>
          <circle cx="12" cy="19" r="1.5" fill="currentColor"/>
        </svg>
      </button>
    </div>
    
    <!-- Tabs -->
    <div class="orders-tabs">
      <button class="orders-tab active" onclick="switchTab('ongoing')">ÏßÑÌñâ Ï§ë</button>
      <button class="orders-tab" onclick="switchTab('history')">ÏßÄÎÇú Ï£ºÎ¨∏</button>
    </div>
    
    <!-- Ongoing Tab Content -->
    <div id="ongoing-content" class="tab-content">
      <!-- ÎèôÏ†ÅÏúºÎ°ú Î°úÎìúÎê® -->
    </div>
    
    <!-- History Tab Content -->
    <div id="history-content" class="tab-content" style="display: none;">
      <!-- ÎèôÏ†ÅÏúºÎ°ú Î°úÎìúÎê® -->
    </div>
  </div>

  <style>
    /* Ï£ºÎ¨∏ Ï∂îÏ†Å Ïä§ÌÉÄÏùº */
    .order-tracking {
      margin: 16px 0;
      padding: 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 12px;
      color: white;
    }

    .tracking-header {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .tracking-steps {
      display: flex;
      justify-content: space-between;
      position: relative;
      margin-bottom: 8px;
    }

    .tracking-step {
      flex: 1;
      text-align: center;
      position: relative;
      z-index: 2;
    }

    .step-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 8px;
      font-size: 20px;
      transition: all 0.3s;
    }

    .step-icon.active {
      background: white;
      color: #667eea;
      box-shadow: 0 4px 12px rgba(255, 255, 255, 0.5);
    }

    .step-icon.completed {
      background: #4CAF50;
      color: white;
    }

    .step-label {
      font-size: 11px;
      opacity: 0.8;
    }

    .step-label.active {
      opacity: 1;
      font-weight: 600;
    }

    .tracking-line {
      position: absolute;
      top: 20px;
      left: 0;
      right: 0;
      height: 2px;
      background: rgba(255, 255, 255, 0.3);
      z-index: 1;
    }

    .tracking-line-progress {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      background: white;
      transition: width 0.5s ease;
    }

    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 8px;
    }

    .status-ordered {
      background: #FFF3E0;
      color: #FF9800;
    }

    .status-cooking {
      background: #E3F2FD;
      color: #2196F3;
    }

    .status-delivering {
      background: #F3E5F5;
      color: #9C27B0;
    }

    .status-delivered {
      background: #E8F5E9;
      color: #4CAF50;
    }

    .status-rejected {
      background: #FFEBEE;
      color: #F44336;
    }

    .status-cancelled {
      background: #F5F5F5;
      color: #757575;
    }
  </style>
  
  <script>
    const baseUrl = window.location.protocol === 'file:' 
      ? 'https://pizzaschool.maejang.com'
      : '';

    let allOrders = [];

    // Î°úÍ∑∏Ïù∏ Ï≤¥ÌÅ¨
    function checkAuthError(response) {
      if (response.status === 401 || response.status === 403) {
        alert('Î°úÍ∑∏Ïù∏Ïù¥ ÎßåÎ£åÎêòÏóàÏäµÎãàÎã§. Îã§Ïãú Î°úÍ∑∏Ïù∏Ìï¥Ï£ºÏÑ∏Ïöî.');
        localStorage.removeItem('accessToken');
        location.href = '02_Login.html';
        return true;
      }
      return false;
    }

    // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï£ºÎ¨∏ Î∂àÎü¨Ïò§Í∏∞
    document.addEventListener('DOMContentLoaded', async function() {
      await loadOrderHistory();
      
      // 30Ï¥àÎßàÎã§ ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ®
      setInterval(() => {
        loadOrderHistory();
      }, 30000);
    });

    // Ï£ºÎ¨∏ ÎÇ¥Ïó≠ Î°úÎìú
    async function loadOrderHistory() {
      const token = localStorage.getItem('accessToken');
      if (!token) {
        alert('Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.');
        location.href = '02_Login.html';
        return;
      }

      try {
        const response = await fetch(`${baseUrl}/api/v1/order/history`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (checkAuthError(response)) return;

        if (!response.ok) {
          throw new Error('Ï£ºÎ¨∏ ÎÇ¥Ïó≠ÏùÑ Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.');
        }

        const data = await response.json();

        if (data.success && data.data) {
          allOrders = data.data;
          renderOrders();
        }

      } catch (error) {
        console.error('Error:', error);
        alert('Ï£ºÎ¨∏ ÎÇ¥Ïó≠ÏùÑ Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
      }
    }
    
    // Ï£ºÎ¨∏ Î†åÎçîÎßÅ
    function renderOrders() {
      // ÏßÑÌñâ Ï§ë: ORDERED, COOKING, DELIVERING
      const ongoingOrders = allOrders.filter(order => 
        ['ORDERED', 'COOKING', 'DELIVERING'].includes(order.condition)
      );
      
      // ÏôÑÎ£å: DELIVERED, CANCELLED, REJECTED
      const historyOrders = allOrders.filter(order => 
        ['DELIVERED', 'CANCELLED', 'REJECTED'].includes(order.condition)
      );
      
      // Ongoing ÌÉ≠
      const ongoingContent = document.getElementById('ongoing-content');
      if (ongoingOrders.length > 0) {
        ongoingContent.innerHTML = ongoingOrders.map(order => renderOrderCard(order, true)).join('');
      } else {
        ongoingContent.innerHTML = '<p style="text-align: center; padding: 40px; color: var(--text-gray);">ÏßÑÌñâÏ§ëÏù∏ Ï£ºÎ¨∏Ïù¥ ÏóÜÏäµÎãàÎã§</p>';
      }
      
      // History ÌÉ≠
      const historyContent = document.getElementById('history-content');
      if (historyOrders.length > 0) {
        historyContent.innerHTML = historyOrders.map(order => renderOrderCard(order, false)).join('');
      } else {
        historyContent.innerHTML = '<p style="text-align: center; padding: 40px; color: var(--text-gray);">Ï£ºÎ¨∏ ÎÇ¥Ïó≠Ïù¥ ÏóÜÏäµÎãàÎã§</p>';
      }
    }

    // Ï£ºÎ¨∏ ÏÉÅÌÉú ÌÖçÏä§Ìä∏
    function getOrderStatusText(condition) {
      const statusMap = {
        'ORDERED': 'Ï£ºÎ¨∏ Ï†ëÏàò',
        'COOKING': 'Ï°∞Î¶¨ Ï§ë',
        'DELIVERING': 'Î∞∞Îã¨ Ï§ë',
        'DELIVERED': 'Î∞∞Îã¨ ÏôÑÎ£å',
        'CANCELLED': 'Ï∑®ÏÜåÎê®',
        'REJECTED': 'Í±∞Ï†àÎê®'
      };
      return statusMap[condition] || condition;
    }

    // Ï£ºÎ¨∏ ÏÉÅÌÉú ÌÅ¥ÎûòÏä§
    function getStatusClass(condition) {
      const classMap = {
        'ORDERED': 'status-ordered',
        'COOKING': 'status-cooking',
        'DELIVERING': 'status-delivering',
        'DELIVERED': 'status-delivered',
        'REJECTED': 'status-rejected',
        'CANCELLED': 'status-cancelled'
      };
      return classMap[condition] || '';
    }

    // Ï£ºÎ¨∏ Ï∂îÏ†Å ÌîÑÎ°úÍ∑∏Î†àÏä§
    function getTrackingProgress(condition) {
      const progressMap = {
        'ORDERED': 25,
        'COOKING': 50,
        'DELIVERING': 75,
        'DELIVERED': 100
      };
      return progressMap[condition] || 0;
    }

    // Ï£ºÎ¨∏ Ï∂îÏ†Å UI
    function renderOrderTracking(order) {
      const steps = [
        { key: 'ORDERED', icon: 'üìù', label: 'Ï£ºÎ¨∏Ï†ëÏàò' },
        { key: 'COOKING', icon: 'üë®‚Äçüç≥', label: 'Ï°∞Î¶¨Ï§ë' },
        { key: 'DELIVERING', icon: 'üöö', label: 'Î∞∞Îã¨Ï§ë' },
        { key: 'DELIVERED', icon: '‚úì', label: 'ÏôÑÎ£å' }
      ];

      const currentIndex = steps.findIndex(s => s.key === order.condition);
      const progress = getTrackingProgress(order.condition);

      return `
        <div class="order-tracking">
          <div class="tracking-header">
            üîî Ï£ºÎ¨∏ Ï∂îÏ†Å
            <span class="status-badge ${getStatusClass(order.condition)}">
              ${getOrderStatusText(order.condition)}
            </span>
          </div>
          
          <div style="position: relative;">
            <div class="tracking-line">
              <div class="tracking-line-progress" style="width: ${progress}%"></div>
            </div>
            
            <div class="tracking-steps">
              ${steps.map((step, index) => `
                <div class="tracking-step">
                  <div class="step-icon ${index < currentIndex ? 'completed' : ''} ${index === currentIndex ? 'active' : ''}">
                    ${step.icon}
                  </div>
                  <div class="step-label ${index === currentIndex ? 'active' : ''}">
                    ${step.label}
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `;
    }

    // Ï£ºÎ¨∏ Ïπ¥Îìú Î†åÎçîÎßÅ
    function renderOrderCard(order, isOngoing) {
      const date = new Date(order.orderAt).toLocaleDateString('ko-KR', {
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
      
      const statusText = getOrderStatusText(order.condition);
      const statusClass = getStatusClass(order.condition);
      
      return `
        <div class="order-card" style="margin-bottom: 16px;">
          <div class="order-header">
            <div class="order-info" style="flex: 1;">
              <h4>Ï£ºÎ¨∏ #${order.id}</h4>
              <p class="order-price">${order.price.toLocaleString()}Ïõê</p>
              <p class="order-items">${date}</p>
            </div>
            <span class="status-badge ${statusClass}">${statusText}</span>
          </div>
          
          ${isOngoing ? renderOrderTracking(order) : ''}
          
          ${order.request ? `
            <p style="font-size: 13px; color: var(--text-gray); margin: 12px 0; padding: 8px; background: var(--bg-light); border-radius: 8px;">
              üí¨ ${order.request}
            </p>
          ` : ''}
          
          <div class="order-actions">
            ${isOngoing && order.condition === 'ORDERED' ? `
              <button class="btn-outline" onclick="cancelOrder(${order.id})">Ï£ºÎ¨∏ Ï∑®ÏÜå</button>
            ` : ''}
            ${!isOngoing ? `
              <button class="btn-primary" onclick="alert('Îã§Ïãú Ï£ºÎ¨∏ÌïòÍ∏∞ Í∏∞Îä•ÏùÄ Ï§ÄÎπÑÏ§ëÏûÖÎãàÎã§')">Îã§Ïãú Ï£ºÎ¨∏</button>
            ` : ''}
          </div>
        </div>
      `;
    }
    
    // Ï£ºÎ¨∏ Ï∑®ÏÜå
    async function cancelOrder(orderId) {
      if (!confirm('Ï£ºÎ¨∏ÏùÑ Ï∑®ÏÜåÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;

      const token = localStorage.getItem('accessToken');

      try {
        const response = await fetch(`${baseUrl}/api/v1/order/delete?orderId=${orderId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (checkAuthError(response)) return;

        if (!response.ok) {
          throw new Error('Ï£ºÎ¨∏ Ï∑®ÏÜåÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
        }

        alert('Ï£ºÎ¨∏Ïù¥ Ï∑®ÏÜåÎêòÏóàÏäµÎãàÎã§.');
        await loadOrderHistory();

      } catch (error) {
        console.error('Error:', error);
        alert('Ï£ºÎ¨∏ Ï∑®ÏÜå Ïã§Ìå®: ' + error.message);
      }
    }
    
    // ÌÉ≠ Ï†ÑÌôò
    function switchTab(tabName) {
      document.querySelectorAll('.orders-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      event.target.classList.add('active');
      
      document.querySelectorAll('.tab-content').forEach(content => {
        content.style.display = 'none';
      });
      
      document.getElementById(tabName + '-content').style.display = 'block';
    }
  </script>
</body>
</html>
