<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>06 Food Details</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="screen-label">메뉴 상세</div>
  
  <div class="container">
    <!-- Food Details Card -->
    <div class="food-details">
      <!-- Image with Back and Favorite Buttons -->
      <div class="image-card" id="menuImage">
        <button class="icon-btn back-btn" onclick="history.back()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M15 18l-6-6 6-6"/>
          </svg>
        </button>
        
        <button class="icon-btn favorite-btn" onclick="toggleFavorite()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
          </svg>
        </button>
      </div>
      
      <!-- Food Name and Location -->
      <h2 class="restaurant-name" id="menuName">로딩 중...</h2>
      
      <div class="restaurant-subtitle">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
          <circle cx="12" cy="10" r="3"/>
        </svg>
        <span id="categoryName">-</span>
      </div>
      
      <!-- Info Section -->
      <div class="info-section">
        <div class="info-item rating">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
          </svg>
          <span>4.7</span>
        </div>
        
        <div class="info-item delivery">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="1" y="3" width="15" height="13" rx="2"/>
            <path d="M16 8h4l3 3v5h-3"/>
            <circle cx="5.5" cy="18.5" r="2.5"/>
            <circle cx="18.5" cy="18.5" r="2.5"/>
          </svg>
          <span>2,500원</span>
        </div>
        
        <div class="info-item time">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <path d="M12 6v6l4 2"/>
          </svg>
          <span>20분</span>
        </div>
      </div>
      
      <!-- Description -->
      <p class="description" id="menuDescription">메뉴 설명을 불러오는 중...</p>
      
      <!-- Options Selection -->
      <div class="size-section" id="optionsSection" style="display: none;">
        <h3>옵션:</h3>
        <div class="size-options" id="optionsList">
          <!-- 동적으로 로드됨 -->
        </div>
      </div>
      
      <!-- Price and Counter -->
      <div class="price-section">
        <div class="price" id="price">$32</div>
        <div class="counter">
          <button class="counter-btn" onclick="decreaseQuantity()">−</button>
          <span class="counter-value" id="quantity">1</span>
          <button class="counter-btn" onclick="increaseQuantity()">+</button>
        </div>
      </div>
      
      <!-- Add to Cart Button -->
      <button class="btn-primary" onclick="addToCart()">장바구니 담기</button>
    </div>
  </div>
  
  <script>
    // baseUrl 처리 (로컬 파일 테스트용)
    const baseUrl = window.location.protocol === 'file:' 
      ? 'https://pizzaschool.maejang.com'
      : '';

    let currentMenu = null;
    let quantity = 1;
    let selectedOption = null;
    let additionalPrice = 0;

    // 페이지 로드 시 메뉴 정보 불러오기
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('[Food Details] Page loaded');
      
      // URL에서 menuId 추출
      const urlParams = new URLSearchParams(window.location.search);
      const menuId = urlParams.get('menuId');

      if (!menuId) {
        alert('메뉴 정보가 없습니다.');
        history.back();
        return;
      }

      console.log('[Food Details] Menu ID:', menuId);

      // JWT 토큰 확인 (선택사항)
      const token = localStorage.getItem('accessToken');
      const OWNER_ID = 1;  // TODO: 가게 선택 페이지에서 받아와야 함

      try {
        // 메뉴 목록에서 해당 메뉴 찾기
        const headers = {};
        if (token) {
          headers['Authorization'] = `Bearer ${token}`;
        }

        const menuResponse = await fetch(`${baseUrl}/api/v1/menu/read?ownerId=${OWNER_ID}`, {
          credentials: 'include',
          headers: headers
        });

        if (!menuResponse.ok) {
          throw new Error('메뉴를 불러올 수 없습니다.');
        }

        const menuData = await menuResponse.json();
        console.log('[Food Details] All menus:', menuData);

        // 해당 menuId 찾기
        currentMenu = menuData.data.find(m => m.menuId === parseInt(menuId));
        
        if (!currentMenu) {
          throw new Error('메뉴를 찾을 수 없습니다.');
        }

        console.log('[Food Details] Found menu:', currentMenu);

        // 페이지에 데이터 표시
        displayMenuDetails();

      } catch (error) {
        console.error('[Food Details] Error:', error);
        alert('메뉴 정보를 불러오는데 실패했습니다: ' + error.message);
        history.back();
      }
    });

    // 메뉴 상세 정보 표시
    function displayMenuDetails() {
      // 이미지 설정
      const imageCard = document.getElementById('menuImage');
      if (currentMenu.picture) {
        imageCard.style.backgroundImage = `url('${currentMenu.picture}')`;
        imageCard.style.backgroundSize = 'cover';
        imageCard.style.backgroundPosition = 'center';
      }

      // 기본 정보
      document.getElementById('menuName').textContent = currentMenu.menuName;
      document.getElementById('categoryName').textContent = currentMenu.category || '메뉴';
      document.getElementById('menuDescription').textContent = currentMenu.description || '맛있는 메뉴입니다.';

      // 옵션 표시
      if (currentMenu.option && currentMenu.option.trim()) {
        const options = currentMenu.option.split(',').map(opt => opt.trim()).filter(opt => opt);
        if (options.length > 0) {
          displayOptions(options);
        }
      }

      // 가격 표시
      updateTotalPrice();
    }

    // 옵션 표시
    function displayOptions(options) {
      const optionsSection = document.getElementById('optionsSection');
      const optionsList = document.getElementById('optionsList');
      
      optionsSection.style.display = 'block';
      
      // 기본 옵션 추가 (옵션 없음)
      let optionsHtml = `<button class="size-option active" onclick="selectOption(this, null, 0)">기본</button>`;
      
      // 각 옵션 파싱 및 버튼 생성
      options.forEach(opt => {
        // "옵션명+가격" 형식 파싱
        const match = opt.match(/^(.+?)\+(\d+)$/);
        if (match) {
          const optionName = match[1].trim();
          const optionPrice = parseInt(match[2]);
          optionsHtml += `<button class="size-option" onclick="selectOption(this, '${optionName}', ${optionPrice})">${optionName} (+${optionPrice.toLocaleString()}원)</button>`;
        } else {
          // 가격 정보가 없는 옵션
          optionsHtml += `<button class="size-option" onclick="selectOption(this, '${opt}', 0)">${opt}</button>`;
        }
      });
      
      optionsList.innerHTML = optionsHtml;
    }

    // 옵션 선택
    function selectOption(button, optionName, price) {
      // 모든 옵션 버튼의 active 클래스 제거
      document.querySelectorAll('.size-option').forEach(btn => {
        btn.classList.remove('active');
      });
      // 선택한 버튼에 active 클래스 추가
      button.classList.add('active');
      
      selectedOption = optionName;
      additionalPrice = price;
      updateTotalPrice();
    }

    // 수량 증가
    function increaseQuantity() {
      quantity++;
      document.getElementById('quantity').textContent = quantity;
      updateTotalPrice();
    }
    
    // 수량 감소 (최소 1)
    function decreaseQuantity() {
      if (quantity > 1) {
        quantity--;
        document.getElementById('quantity').textContent = quantity;
        updateTotalPrice();
      }
    }

    // 총 가격 업데이트
    function updateTotalPrice() {
      if (!currentMenu) return;
      const totalPrice = (currentMenu.price + additionalPrice) * quantity;
      document.getElementById('price').textContent = totalPrice.toLocaleString() + '원';
    }

    // 찜하기 토글
    function toggleFavorite() {
      const btn = document.querySelector('.favorite-btn');
      btn.classList.toggle('active');
      
      if (btn.classList.contains('active')) {
        btn.querySelector('svg').setAttribute('fill', 'currentColor');
      } else {
        btn.querySelector('svg').setAttribute('fill', 'none');
      }
    }

    // 장바구니에 추가
    function addToCart() {
      if (!currentMenu) {
        alert('메뉴 정보를 불러오는 중입니다.');
        return;
      }

      // TODO: 장바구니 API 연동 (/api/v1/cart/add)
      // 현재는 localStorage에 저장 (임시)
      const cartItem = {
        menuId: currentMenu.menuId,
        menuName: currentMenu.menuName,
        price: currentMenu.price,
        quantity: quantity,
        option: selectedOption,
        additionalPrice: additionalPrice,
        totalPrice: (currentMenu.price + additionalPrice) * quantity,
        picture: currentMenu.picture
      };

      // localStorage에 저장
      let cart = JSON.parse(localStorage.getItem('cart') || '[]');
      
      // 같은 메뉴 + 같은 옵션이 있으면 수량만 증가
      const existingItemIndex = cart.findIndex(item => 
        item.menuId === cartItem.menuId && item.option === cartItem.option
      );
      
      if (existingItemIndex >= 0) {
        cart[existingItemIndex].quantity += quantity;
        cart[existingItemIndex].totalPrice = (cart[existingItemIndex].price + cart[existingItemIndex].additionalPrice) * cart[existingItemIndex].quantity;
      } else {
        cart.push(cartItem);
      }
      
      localStorage.setItem('cart', JSON.stringify(cart));

      // 장바구니 이동 여부 확인
      const optionText = selectedOption ? ` (옵션: ${selectedOption})` : '';
      if (confirm(`${quantity}개${optionText}가 장바구니에 담겼습니다.\n장바구니로 이동하시겠습니까?`)) {
        location.href = '07_Cart.html';
      } else {
        // 수량 초기화
        quantity = 1;
        document.getElementById('quantity').textContent = quantity;
        updateTotalPrice();
      }
    }
  </script>
</body>
</html>
