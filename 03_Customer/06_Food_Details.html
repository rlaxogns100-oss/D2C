<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>06 Food Details</title>
  <link rel="stylesheet" href="style.css">
  <script src="config.js"></script>
</head>
<body>
  <div class="screen-label">ë©”ë‰´ ìƒì„¸</div>
  
  <div class="container">
    <!-- Food Details Card -->
    <div class="food-details">
      <!-- Image with Back and Favorite Buttons -->
      <div class="image-card" id="menuImage">
        <button class="icon-btn back-btn" onclick="history.back()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M15 18l-6-6 6-6"/>
          </svg>
        </button>
        
        <button class="icon-btn favorite-btn" onclick="toggleFavorite()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
          </svg>
        </button>
      </div>
      
      <!-- Food Name and Location -->
      <h2 class="restaurant-name" id="menuName">ë¡œë”© ì¤‘...</h2>
      
      <div class="restaurant-subtitle">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
          <circle cx="12" cy="10" r="3"/>
        </svg>
        <span id="categoryName">-</span>
      </div>
      
      <!-- Info Section -->
      <div class="info-section">
        <div class="info-item rating">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
          </svg>
          <span>4.7</span>
        </div>
        
        <div class="info-item delivery">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="1" y="3" width="15" height="13" rx="2"/>
            <path d="M16 8h4l3 3v5h-3"/>
            <circle cx="5.5" cy="18.5" r="2.5"/>
            <circle cx="18.5" cy="18.5" r="2.5"/>
          </svg>
          <span>2,500ì›</span>
        </div>
        
        <div class="info-item time">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <path d="M12 6v6l4 2"/>
          </svg>
          <span>20ë¶„</span>
        </div>
      </div>
      
      <!-- Description -->
      <p class="description" id="menuDescription">ë©”ë‰´ ì„¤ëª…ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
      
      <!-- Options Selection -->
      <div class="size-section" id="optionsSection" style="display: none;">
        <h3>ì˜µì…˜:</h3>
        <div class="size-options" id="optionsList">
          <!-- ë™ì ìœ¼ë¡œ ë¡œë“œë¨ -->
        </div>
      </div>
      
      <!-- Price and Counter -->
      <div class="price-section">
        <div class="price" id="price">$32</div>
        <div class="counter">
          <button class="counter-btn" onclick="decreaseQuantity()">âˆ’</button>
          <span class="counter-value" id="quantity">1</span>
          <button class="counter-btn" onclick="increaseQuantity()">+</button>
        </div>
      </div>
      
      <!-- Add to Cart Button -->
      <button class="btn-primary" onclick="addToCart()">ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°</button>
    </div>
  </div>
  
  <script>
    // baseUrl ì²˜ë¦¬ (ë¡œì»¬ íŒŒì¼ í…ŒìŠ¤íŠ¸ìš©)
    // config.jsì—ì„œ ê°€ì ¸ì˜´

    let currentMenu = null;
    let quantity = 1;
    let selectedOption = null;
    let additionalPrice = 0;

    // ğŸª ì´ ë§¤ì¥ì˜ Owner ID (config.jsì—ì„œ ê°€ì ¸ì˜´)
    // const OWNER_ID = 11;

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë©”ë‰´ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
    document.addEventListener('DOMContentLoaded', async () => {
      // 1. ì„¤ì • ë¡œë“œ ëŒ€ê¸°
      if (window.STORE_CONFIG_LOADED) {
        await window.STORE_CONFIG_LOADED;
      }
      
      console.log('[Food Details] Page loaded');
      
      // URLì—ì„œ menuId ì¶”ì¶œ
      const urlParams = new URLSearchParams(window.location.search);
      const menuId = urlParams.get('menuId');

      if (!menuId) {
        alert('ë©”ë‰´ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
        history.back();
        return;
      }

      console.log('[Food Details] Menu ID:', menuId);
      console.log('[Food Details] Store Owner ID:', OWNER_ID);

      try {
        // ì´ ë§¤ì¥(OWNER_ID)ì˜ ë©”ë‰´ ëª©ë¡ì—ì„œ í•´ë‹¹ ë©”ë‰´ ì°¾ê¸°
        // ë¹„ë¡œê·¸ì¸ ìƒíƒœì—ì„œë„ ì¡°íšŒ ê°€ëŠ¥
        const menuResponse = await fetch(`${baseUrl}/api/v1/menu/read?ownerId=${OWNER_ID}`, {
          credentials: 'include'
        });

        if (!menuResponse.ok) {
          throw new Error('ë©”ë‰´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }

        const menuData = await menuResponse.json();
        console.log('[Food Details] All menus:', menuData);

        // í•´ë‹¹ menuId ì°¾ê¸°
        currentMenu = menuData.data.find(m => m.menuId === parseInt(menuId));
        
        if (!currentMenu) {
          throw new Error('ë©”ë‰´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }

        console.log('[Food Details] Found menu:', currentMenu);

        // í˜ì´ì§€ì— ë°ì´í„° í‘œì‹œ
        displayMenuDetails();

      } catch (error) {
        console.error('[Food Details] Error:', error);
        alert('ë©”ë‰´ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
        history.back();
      }
    });

    // ë©”ë‰´ ìƒì„¸ ì •ë³´ í‘œì‹œ
    function displayMenuDetails() {
      // ì´ë¯¸ì§€ ì„¤ì •
      const imageCard = document.getElementById('menuImage');
      if (currentMenu.picture) {
        imageCard.style.backgroundImage = `url('${currentMenu.picture}')`;
        imageCard.style.backgroundSize = 'cover';
        imageCard.style.backgroundPosition = 'center';
      }

      // ê¸°ë³¸ ì •ë³´
      document.getElementById('menuName').textContent = currentMenu.menuName;
      document.getElementById('categoryName').textContent = currentMenu.category || 'ë©”ë‰´';
      document.getElementById('menuDescription').textContent = currentMenu.description || 'ë§›ìˆëŠ” ë©”ë‰´ì…ë‹ˆë‹¤.';

      // ì˜µì…˜ í‘œì‹œ
      if (currentMenu.option && currentMenu.option.trim()) {
        const options = currentMenu.option.split(',').map(opt => opt.trim()).filter(opt => opt);
        if (options.length > 0) {
          displayOptions(options);
        }
      }

      // ê°€ê²© í‘œì‹œ
      updateTotalPrice();
    }

    // ì˜µì…˜ í‘œì‹œ
    function displayOptions(options) {
      const optionsSection = document.getElementById('optionsSection');
      const optionsList = document.getElementById('optionsList');
      
      optionsSection.style.display = 'block';
      
      // ê¸°ë³¸ ì˜µì…˜ ì¶”ê°€ (ì˜µì…˜ ì—†ìŒ)
      let optionsHtml = `<button class="size-option active" onclick="selectOption(this, null, 0)">ê¸°ë³¸</button>`;
      
      // ê° ì˜µì…˜ íŒŒì‹± ë° ë²„íŠ¼ ìƒì„±
      options.forEach(opt => {
        // "ì˜µì…˜ëª…+ê°€ê²©" í˜•ì‹ íŒŒì‹±
        const match = opt.match(/^(.+?)\+(\d+)$/);
        if (match) {
          const optionName = match[1].trim();
          const optionPrice = parseInt(match[2]);
          optionsHtml += `<button class="size-option" onclick="selectOption(this, '${optionName}', ${optionPrice})">${optionName} (+${optionPrice.toLocaleString()}ì›)</button>`;
        } else {
          // ê°€ê²© ì •ë³´ê°€ ì—†ëŠ” ì˜µì…˜
          optionsHtml += `<button class="size-option" onclick="selectOption(this, '${opt}', 0)">${opt}</button>`;
        }
      });
      
      optionsList.innerHTML = optionsHtml;
    }

    // ì˜µì…˜ ì„ íƒ
    function selectOption(button, optionName, price) {
      // ëª¨ë“  ì˜µì…˜ ë²„íŠ¼ì˜ active í´ë˜ìŠ¤ ì œê±°
      document.querySelectorAll('.size-option').forEach(btn => {
        btn.classList.remove('active');
      });
      // ì„ íƒí•œ ë²„íŠ¼ì— active í´ë˜ìŠ¤ ì¶”ê°€
      button.classList.add('active');
      
      selectedOption = optionName;
      additionalPrice = price;
      updateTotalPrice();
    }

    // ìˆ˜ëŸ‰ ì¦ê°€
    function increaseQuantity() {
      quantity++;
      document.getElementById('quantity').textContent = quantity;
      updateTotalPrice();
    }
    
    // ìˆ˜ëŸ‰ ê°ì†Œ (ìµœì†Œ 1)
    function decreaseQuantity() {
      if (quantity > 1) {
        quantity--;
        document.getElementById('quantity').textContent = quantity;
        updateTotalPrice();
      }
    }

    // ì´ ê°€ê²© ì—…ë°ì´íŠ¸
    function updateTotalPrice() {
      if (!currentMenu) return;
      const totalPrice = (currentMenu.price + additionalPrice) * quantity;
      document.getElementById('price').textContent = totalPrice.toLocaleString() + 'ì›';
    }

    // ì°œí•˜ê¸° í† ê¸€
    function toggleFavorite() {
      const btn = document.querySelector('.favorite-btn');
      btn.classList.toggle('active');
      
      if (btn.classList.contains('active')) {
        btn.querySelector('svg').setAttribute('fill', 'currentColor');
      } else {
        btn.querySelector('svg').setAttribute('fill', 'none');
      }
    }

    // ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€
    function addToCart() {
      if (!currentMenu) {
        alert('ë©”ë‰´ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤.');
        return;
      }

      // TODO: ì¥ë°”êµ¬ë‹ˆ API ì—°ë™ (/api/v1/cart/add)
      // í˜„ì¬ëŠ” localStorageì— ì €ì¥ (ì„ì‹œ)
      const cartItem = {
        menuId: currentMenu.menuId,
        menuName: currentMenu.menuName,
        price: currentMenu.price,
        quantity: quantity,
        option: selectedOption,
        additionalPrice: additionalPrice,
        totalPrice: (currentMenu.price + additionalPrice) * quantity,
        picture: currentMenu.picture,
        ownerId: OWNER_ID  // ì£¼ë¬¸ ìƒì„± ì‹œ í•„ìš”
      };

      // localStorageì— ì €ì¥
      let cart = JSON.parse(localStorage.getItem('cart') || '[]');
      
      // ê°™ì€ ë©”ë‰´ + ê°™ì€ ì˜µì…˜ì´ ìˆìœ¼ë©´ ìˆ˜ëŸ‰ë§Œ ì¦ê°€
      const existingItemIndex = cart.findIndex(item => 
        item.menuId === cartItem.menuId && item.option === cartItem.option
      );
      
      if (existingItemIndex >= 0) {
        cart[existingItemIndex].quantity += quantity;
        cart[existingItemIndex].totalPrice = (cart[existingItemIndex].price + cart[existingItemIndex].additionalPrice) * cart[existingItemIndex].quantity;
      } else {
        cart.push(cartItem);
      }
      
      localStorage.setItem('cart', JSON.stringify(cart));

      // ì¥ë°”êµ¬ë‹ˆ ì´ë™ ì—¬ë¶€ í™•ì¸
      const optionText = selectedOption ? ` (ì˜µì…˜: ${selectedOption})` : '';
      if (confirm(`${quantity}ê°œ${optionText}ê°€ ì¥ë°”êµ¬ë‹ˆì— ë‹´ê²¼ìŠµë‹ˆë‹¤.\nì¥ë°”êµ¬ë‹ˆë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        location.href = '07_Cart.html';
      } else {
        // ìˆ˜ëŸ‰ ì´ˆê¸°í™”
        quantity = 1;
        document.getElementById('quantity').textContent = quantity;
        updateTotalPrice();
      }
    }
  </script>
</body>
</html>
