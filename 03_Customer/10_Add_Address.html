<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>10 Add Address</title>
  <link rel="stylesheet" href="style.css">
  <!-- ì¹´ì¹´ì˜¤ ë§µ API -->
  <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=18d5884d5326027cfa1a256d516a78ec&libraries=services"></script>
  <!-- ì¹´ì¹´ì˜¤ ì£¼ì†Œ ê²€ìƒ‰ API -->
  <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
</head>
<body>
  <div class="screen-label">ìƒˆ ì£¼ì†Œ ì¶”ê°€</div>
  
  <div class="container">
    <!-- Header -->
    <div class="orders-header">
      <button class="icon-btn back-btn" style="position: static;" onclick="history.back()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M15 18l-6-6 6-6"/>
        </svg>
      </button>
      <div style="width: 40px;"></div>
    </div>
    
    <!-- Map -->
    <div id="map" class="map-container" style="position: relative;">
      <!-- ì¹´ì¹´ì˜¤ ë§µì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
    </div>
    
    <!-- Address Preview -->
    <div class="address-preview" id="addressPreview" style="display: none;">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
        <circle cx="12" cy="10" r="3"/>
      </svg>
      <p id="addressPreviewText"></p>
    </div>
    
    <!-- Form -->
    <form onsubmit="return validateAddress(event)">
      <div class="form-group">
        <label class="form-label" for="street">ë„ë¡œëª… ì£¼ì†Œ</label>
        <div style="display: flex; gap: 8px;">
          <input 
            type="text" 
            id="street" 
            class="form-input" 
            placeholder="ì£¼ì†Œ ê²€ìƒ‰ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”"
            style="flex: 1;"
            readonly
            required
          >
          <button 
            type="button" 
            onclick="searchAddress()" 
            style="padding: 12px 20px; background: #FF6B35; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; white-space: nowrap;">
            ì£¼ì†Œ ê²€ìƒ‰
          </button>
        </div>
        <!-- ì¢Œí‘œ ì €ì¥ìš© hidden input -->
        <input type="hidden" id="latitude">
        <input type="hidden" id="longitude">
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label class="form-label" for="postcode">ìš°í¸ë²ˆí˜¸</label>
          <input 
            type="text" 
            id="postcode" 
            class="form-input" 
            placeholder="34567"
            readonly
            required
          >
        </div>
      </div>
      
      <div class="form-group">
        <label class="form-label" for="apartment">ìƒì„¸ ì£¼ì†Œ</label>
        <input 
          type="text" 
          id="apartment" 
          class="form-input" 
          placeholder="345"
        >
      </div>
      
      <div class="form-group">
        <label class="form-label">ì£¼ì†Œ ë³„ì¹­</label>
        <div class="label-options">
          <button type="button" class="label-btn active" onclick="selectLabel(this, 'ì§‘')">ì§‘</button>
          <button type="button" class="label-btn" onclick="selectLabel(this, 'íšŒì‚¬')">íšŒì‚¬</button>
          <button type="button" class="label-btn" onclick="selectLabel(this, 'í•™êµ')">í•™êµ</button>
          <button type="button" class="label-btn" onclick="selectLabel(this, 'custom')">ì§ì ‘ ì…ë ¥</button>
        </div>
        <input 
          type="text" 
          id="customLabel" 
          class="form-input" 
          placeholder="ì£¼ì†Œ ë³„ì¹­ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: í• ë¨¸ë‹ˆëŒ, ì¹œêµ¬ì§‘ ë“±)"
          style="display: none; margin-top: 12px;"
        >
      </div>
      
      <button type="submit" class="btn-primary">ì£¼ì†Œ ì €ì¥</button>
    </form>
  </div>
  
  <script>
    // baseUrl ì²˜ë¦¬ (ë¡œì»¬ íŒŒì¼ í…ŒìŠ¤íŠ¸ìš©)
    const baseUrl = window.location.protocol === 'file:' 
      ? 'https://pizzaschool.maejang.com'
      : '';

    // ğŸ—ºï¸ ì¹´ì¹´ì˜¤ ë§µ & ë§ˆì»¤
    let map;
    let storeMarker; // ê°€ê²Œ ìœ„ì¹˜ ë§ˆì»¤ (ë¹¨ê°•)
    let customerMarker; // ê³ ê° ì£¼ì†Œ ë§ˆì»¤ (íŒŒë‘)
    const STORE_ID = 11; // user_id=11ì˜ store_id
    let storeInfo = {
      lat: 37.5012743,
      lng: 127.0396597,
      deliveryRadius: null
    };

    // ğŸ” ë¡œê·¸ì¸ ë§Œë£Œ ì²´í¬ ë° ìë™ ë¦¬ë‹¤ì´ë ‰íŠ¸
    function checkAuthError(response) {
      if (response.status === 401 || response.status === 403) {
        alert('ë¡œê·¸ì¸ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
        localStorage.removeItem('accessToken');
        location.href = '02_Login.html';
        return true;
      }
      return false;
    }

    // ê°€ê²Œ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadStoreInfo() {
      try {
        const response = await fetch(`${baseUrl}/api/v1/store/${STORE_ID}`);
        const result = await response.json();
        
        if (response.ok && result.success && result.data) {
          const store = result.data;
          if (store.latitude && store.longitude) {
            storeInfo.lat = store.latitude;
            storeInfo.lng = store.longitude;
            storeInfo.deliveryRadius = store.deliveryRadius;
          }
        }
      } catch (error) {
        console.error('ê°€ê²Œ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
      }
    }

    // ë‘ ì¢Œí‘œ ê°„ ê±°ë¦¬ ê³„ì‚° (Haversine formula, km ë‹¨ìœ„)
    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371; // ì§€êµ¬ ë°˜ê²½ (km)
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¡œê·¸ì¸ í™•ì¸ ë° ì§€ë„ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', function() {
      const token = localStorage.getItem('accessToken');
      if (!token) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        location.href = '02_Login.html';
        return;
      }

      // ì¹´ì¹´ì˜¤ ë§µ ì´ˆê¸°í™” (ê°€ê²Œ ìœ„ì¹˜ ì¤‘ì‹¬)
      initializeMap();
    });

    // ì¹´ì¹´ì˜¤ ë§µ ì´ˆê¸°í™”
    function initializeMap() {
      const mapContainer = document.getElementById('map');
      const mapOption = {
        center: new kakao.maps.LatLng(storeInfo.lat, storeInfo.lng),
        level: 4
      };
      
      map = new kakao.maps.Map(mapContainer, mapOption);
      
      // ê°€ê²Œ ìœ„ì¹˜ ë§ˆì»¤ ì¶”ê°€ (ë¹¨ê°•)
      storeMarker = new kakao.maps.Marker({
        position: new kakao.maps.LatLng(storeInfo.lat, storeInfo.lng),
        map: map
      });

      // ê°€ê²Œ ë§ˆì»¤ì— ì¸í¬ìœˆë„ìš° ì¶”ê°€
      const storeInfowindow = new kakao.maps.InfoWindow({
        content: '<div style="padding:5px;font-size:12px;color:#FF6B35;font-weight:600;">ğŸª ê°€ê²Œ ìœ„ì¹˜</div>'
      });
      storeInfowindow.open(map, storeMarker);
    }

    // ì¹´ì¹´ì˜¤ ì£¼ì†Œ ê²€ìƒ‰ íŒì—…
    function searchAddress() {
      new daum.Postcode({
        oncomplete: function(data) {
          // ì„ íƒí•œ ì£¼ì†Œ ì •ë³´
          const roadAddr = data.roadAddress; // ë„ë¡œëª… ì£¼ì†Œ
          const zonecode = data.zonecode; // ìš°í¸ë²ˆí˜¸
          
          // í¼ì— ì£¼ì†Œ ì…ë ¥
          document.getElementById('street').value = roadAddr;
          document.getElementById('postcode').value = zonecode;
          
          // ì£¼ì†Œ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
          document.getElementById('addressPreview').style.display = 'flex';
          document.getElementById('addressPreviewText').textContent = roadAddr;
          
          // ì¢Œí‘œ ë³€í™˜ (ì£¼ì†Œ â†’ ìœ„ë„/ê²½ë„)
          const geocoder = new kakao.maps.services.Geocoder();
          geocoder.addressSearch(roadAddr, function(result, status) {
            if (status === kakao.maps.services.Status.OK) {
              const coords = new kakao.maps.LatLng(result[0].y, result[0].x);
              
              // ì¢Œí‘œ ì €ì¥
              document.getElementById('latitude').value = result[0].y;
              document.getElementById('longitude').value = result[0].x;
              
              // ì§€ë„ì— ê³ ê° ì£¼ì†Œ ë§ˆì»¤ ì¶”ê°€ (íŒŒë‘)
              if (customerMarker) {
                customerMarker.setMap(null); // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
              }
              
              customerMarker = new kakao.maps.Marker({
                position: coords,
                map: map
              });
              
              // ê³ ê° ë§ˆì»¤ì— ì¸í¬ìœˆë„ìš° ì¶”ê°€
              const customerInfowindow = new kakao.maps.InfoWindow({
                content: '<div style="padding:5px;font-size:12px;color:#4A90E2;font-weight:600;">ğŸ“ ë°°ë‹¬ ì£¼ì†Œ</div>'
              });
              customerInfowindow.open(map, customerMarker);
              
              // ë‘ ë§ˆì»¤ê°€ ëª¨ë‘ ë³´ì´ë„ë¡ ì§€ë„ ë²”ìœ„ ì¡°ì •
              const bounds = new kakao.maps.LatLngBounds();
              bounds.extend(new kakao.maps.LatLng(storeInfo.lat, storeInfo.lng));
              bounds.extend(coords);
              map.setBounds(bounds);

              // ë°°ë‹¬ ê¶Œì—­ ì²´í¬
              if (storeInfo.deliveryRadius) {
                const distance = calculateDistance(
                  storeInfo.lat, storeInfo.lng,
                  parseFloat(result[0].y), parseFloat(result[0].x)
                );
                
                if (distance > storeInfo.deliveryRadius) {
                  alert(`âš ï¸ ë°°ë‹¬ ê¶Œì—­ ë°–ì˜ ì£¼ì†Œì…ë‹ˆë‹¤.\n\nê°€ê²Œì™€ì˜ ê±°ë¦¬: ${distance.toFixed(2)}km\në°°ë‹¬ ê°€ëŠ¥ ë°˜ê²½: ${storeInfo.deliveryRadius}km\n\nì£¼ì†ŒëŠ” ì €ì¥í•  ìˆ˜ ìˆì§€ë§Œ, ì£¼ë¬¸ì´ ê±°ë¶€ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
                }
              }
            }
          });
        }
      }).open();
    }
    
    // ë¼ë²¨ ì„ íƒ ê¸°ëŠ¥
    function selectLabel(button, labelType) {
      // ëª¨ë“  ë¼ë²¨ ë²„íŠ¼ì˜ active í´ë˜ìŠ¤ ì œê±°
      document.querySelectorAll('.label-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      // í´ë¦­í•œ ë²„íŠ¼ì— active í´ë˜ìŠ¤ ì¶”ê°€
      button.classList.add('active');
      
      // ì§ì ‘ ì…ë ¥ì¸ ê²½ìš° input í‘œì‹œ
      const customInput = document.getElementById('customLabel');
      if (labelType === 'custom') {
        customInput.style.display = 'block';
        customInput.required = true;
      } else {
        customInput.style.display = 'none';
        customInput.required = false;
        customInput.value = '';
      }
    }
    
    // ì£¼ì†Œ í¼ ìœ íš¨ì„± ê²€ì‚¬ ë° ì €ì¥
    async function validateAddress(event) {
      event.preventDefault();
      
      const street = document.getElementById('street').value.trim();
      const postcode = document.getElementById('postcode').value.trim();
      const apartment = document.getElementById('apartment').value.trim();
      const latitude = document.getElementById('latitude').value;
      const longitude = document.getElementById('longitude').value;
      
      // ì£¼ì†Œ ê²€ìƒ‰ ì—¬ë¶€ ì²´í¬
      if (!latitude || !longitude) {
        alert('ì£¼ì†Œ ê²€ìƒ‰ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì£¼ì†Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”');
        return false;
      }
      
      // ê±°ë¦¬ ì£¼ì†Œ ë¹ˆ ê°’ ì²´í¬
      if (street === '') {
        alert('ì£¼ì†Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”');
        return false;
      }
      
      // ìš°í¸ë²ˆí˜¸ ë¹ˆ ê°’ ì²´í¬
      if (postcode === '') {
        alert('ìš°í¸ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
        return false;
      }
      
      // ì„ íƒëœ ë¼ë²¨ ê°€ì ¸ì˜¤ê¸°
      const labelButton = document.querySelector('.label-btn.active');
      let label = labelButton ? labelButton.textContent : 'ì§‘';
      
      // ì§ì ‘ ì…ë ¥ì¸ ê²½ìš° customLabel ê°’ ì‚¬ìš©
      if (label === 'ì§ì ‘ ì…ë ¥') {
        const customLabel = document.getElementById('customLabel').value.trim();
        if (customLabel === '') {
          alert('ì£¼ì†Œ ë³„ì¹­ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
          return false;
        }
        label = customLabel;
      }
      
      // ì£¼ì†Œ ë°ì´í„° ìƒì„±
      const addressData = {
        name: label,
        address: `${street}${apartment ? ', ' + apartment : ''} (${postcode})`,
        latitude: parseFloat(latitude),
        longitude: parseFloat(longitude)
      };

      // API í˜¸ì¶œ
      const token = localStorage.getItem('accessToken');
      if (!token) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        location.href = '02_Login.html';
        return false;
      }

      try {
        const response = await fetch(`${baseUrl}/api/v1/address/create`, {
          method: 'POST',
          credentials: 'include',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(addressData)
        });

        if (checkAuthError(response)) return false;

        const result = await response.json();
        console.log('[Add Address] Response:', result);

        if (response.ok && result.success) {
          alert('ì£¼ì†Œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
          location.href = '09_Address.html';
        } else {
          throw new Error(result.message || 'ì£¼ì†Œ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }

      } catch (error) {
        console.error('[Add Address] Error:', error);
        alert('ì£¼ì†Œ ì €ì¥ ì‹¤íŒ¨: ' + error.message);
      }
      
      return false;
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ê°€ê²Œ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
    window.onload = async function() {
      await loadStoreInfo();
      initializeMap();
    };
  </script>
</body>
</html>
