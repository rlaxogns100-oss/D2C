<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>10 Add Address</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="screen-label">ìƒˆ ì£¼ì†Œ ì¶”ê°€</div>
  
  <div class="container">
    <!-- Header -->
    <div class="orders-header">
      <button class="icon-btn back-btn" style="position: static;" onclick="history.back()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M15 18l-6-6 6-6"/>
        </svg>
      </button>
      <div style="width: 40px;"></div>
    </div>
    
    <!-- Map -->
    <div class="map-container">
      <div class="map-marker"></div>
      <button style="position: absolute; top: 16px; right: 16px; padding: 8px 16px; background: #2D3E50; color: white; border: none; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer;">
        ìœ„ì¹˜ ìˆ˜ì •
      </button>
    </div>
    
    <!-- Address Preview -->
    <div class="address-preview">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
        <circle cx="12" cy="10" r="3"/>
      </svg>
      <p>3235 Royal Ln. Mesa, New Jersy 34567</p>
    </div>
    
    <!-- Form -->
    <form onsubmit="return validateAddress(event)">
      <div class="form-group">
        <label class="form-label" for="street">ë„ë¡œëª… ì£¼ì†Œ</label>
        <div class="form-row">
          <input 
            type="text" 
            id="street" 
            class="form-input" 
            placeholder="Hasan Nagar"
            style="grid-column: 1 / -1;"
            required
          >
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label class="form-label" for="postcode">ìš°í¸ë²ˆí˜¸</label>
          <input 
            type="text" 
            id="postcode" 
            class="form-input" 
            placeholder="34567"
            required
          >
        </div>
      </div>
      
      <div class="form-group">
        <label class="form-label" for="apartment">ìƒì„¸ ì£¼ì†Œ</label>
        <input 
          type="text" 
          id="apartment" 
          class="form-input" 
          placeholder="345"
        >
      </div>
      
      <div class="form-group">
        <label class="form-label">ì£¼ì†Œ ë³„ì¹­</label>
        <div class="label-options">
          <button type="button" class="label-btn active" onclick="selectLabel(this)">ì§‘</button>
          <button type="button" class="label-btn" onclick="selectLabel(this)">íšŒì‚¬</button>
          <button type="button" class="label-btn" onclick="selectLabel(this)">ê¸°íƒ€</button>
        </div>
      </div>
      
      <button type="submit" class="btn-primary">ì£¼ì†Œ ì €ì¥</button>
    </form>
  </div>
  
  <script>
    // baseUrl ì²˜ë¦¬ (ë¡œì»¬ íŒŒì¼ í…ŒìŠ¤íŠ¸ìš©)
    const baseUrl = window.location.protocol === 'file:' 
      ? 'https://pizzaschool.maejang.com'
      : '';

    // ğŸ” ë¡œê·¸ì¸ ë§Œë£Œ ì²´í¬ ë° ìë™ ë¦¬ë‹¤ì´ë ‰íŠ¸
    function checkAuthError(response) {
      if (response.status === 401 || response.status === 403) {
        alert('ë¡œê·¸ì¸ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
        localStorage.removeItem('accessToken');
        location.href = '02_Login.html';
        return true;
      }
      return false;
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¡œê·¸ì¸ í™•ì¸
    document.addEventListener('DOMContentLoaded', function() {
      const token = localStorage.getItem('accessToken');
      if (!token) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        location.href = '02_Login.html';
        return;
      }
    });
    
    // ë¼ë²¨ ì„ íƒ ê¸°ëŠ¥
    function selectLabel(button) {
      // ëª¨ë“  ë¼ë²¨ ë²„íŠ¼ì˜ active í´ë˜ìŠ¤ ì œê±°
      document.querySelectorAll('.label-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      // í´ë¦­í•œ ë²„íŠ¼ì— active í´ë˜ìŠ¤ ì¶”ê°€
      button.classList.add('active');
    }
    
    // ì£¼ì†Œ í¼ ìœ íš¨ì„± ê²€ì‚¬ ë° ì €ì¥
    async function validateAddress(event) {
      event.preventDefault();
      
      const street = document.getElementById('street').value.trim();
      const postcode = document.getElementById('postcode').value.trim();
      const apartment = document.getElementById('apartment').value.trim();
      
      // ê±°ë¦¬ ì£¼ì†Œ ë¹ˆ ê°’ ì²´í¬
      if (street === '') {
        alert('ê±°ë¦¬ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
        return false;
      }
      
      // ê±°ë¦¬ ì£¼ì†Œ ê¸¸ì´ ì²´í¬
      if (street.length < 5) {
        alert('ê±°ë¦¬ ì£¼ì†ŒëŠ” 5ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”');
        return false;
      }
      
      // ìš°í¸ë²ˆí˜¸ ë¹ˆ ê°’ ì²´í¬
      if (postcode === '') {
        alert('ìš°í¸ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
        return false;
      }
      
      // ìš°í¸ë²ˆí˜¸ ìˆ«ì ì²´í¬
      if (!/^\d+$/.test(postcode)) {
        alert('ìš°í¸ë²ˆí˜¸ëŠ” ìˆ«ìë§Œ ì…ë ¥í•´ì£¼ì„¸ìš”');
        return false;
      }
      
      // ìš°í¸ë²ˆí˜¸ ê¸¸ì´ ì²´í¬ (5ìë¦¬)
      if (postcode.length !== 5) {
        alert('ìš°í¸ë²ˆí˜¸ëŠ” 5ìë¦¬ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤');
        return false;
      }
      
      // ì„ íƒëœ ë¼ë²¨ ê°€ì ¸ì˜¤ê¸°
      const labelButton = document.querySelector('.label-btn.active');
      const label = labelButton ? labelButton.textContent : 'ì§‘';
      
      // ì£¼ì†Œ ë°ì´í„° ìƒì„±
      const addressData = {
        title: label,
        detail: `${street}, ${apartment ? apartment + ', ' : ''}${postcode}`
      };

      // API í˜¸ì¶œ
      const token = localStorage.getItem('accessToken');
      if (!token) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        location.href = '02_Login.html';
        return false;
      }

      try {
        const response = await fetch(`${baseUrl}/api/v1/address/create`, {
          method: 'POST',
          credentials: 'include',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(addressData)
        });

        if (checkAuthError(response)) return false;

        const result = await response.json();
        console.log('[Add Address] Response:', result);

        if (response.ok && result.success) {
          alert('ì£¼ì†Œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
          location.href = '09_Address.html';
        } else {
          throw new Error(result.message || 'ì£¼ì†Œ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }

      } catch (error) {
        console.error('[Add Address] Error:', error);
        alert('ì£¼ì†Œ ì €ì¥ ì‹¤íŒ¨: ' + error.message);
      }
      
      return false;
    }
  </script>
</body>
</html>
