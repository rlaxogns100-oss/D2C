<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>09 Address</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="screen-label">ì£¼ì†Œ ê´€ë¦¬</div>
  
  <div class="container">
    <!-- Header -->
    <div class="orders-header">
      <button class="icon-btn back-btn" style="position: static;" onclick="history.back()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M15 18l-6-6 6-6"/>
        </svg>
      </button>
      <h2>ë‚´ ì£¼ì†Œ ëª©ë¡</h2>
      <div style="width: 40px;"></div>
    </div>
    
    <!-- Address Cards (ë™ì ìœ¼ë¡œ ë¡œë“œë¨) -->
    <div id="addressList">
      <!-- JavaScriptë¡œ ìë™ ìƒì„± -->
    </div>
    
    <button class="btn-primary" onclick="location.href='10_Add_Address.html'">ìƒˆ ì£¼ì†Œ ì¶”ê°€</button>
  </div>
  
  <script>
    // baseUrl ì²˜ë¦¬ (ë¡œì»¬ íŒŒì¼ í…ŒìŠ¤íŠ¸ìš©)
    const baseUrl = window.location.protocol === 'file:' 
      ? 'https://pizzaschool.maejang.com'
      : '';

    // ğŸ” ë¡œê·¸ì¸ ë§Œë£Œ ì²´í¬ ë° ìë™ ë¦¬ë‹¤ì´ë ‰íŠ¸
    function checkAuthError(response) {
      if (response.status === 401 || response.status === 403) {
        alert('ë¡œê·¸ì¸ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
        localStorage.removeItem('accessToken');
        location.href = '02_Login.html';
        return true;
      }
      return false;
    }
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì£¼ì†Œ ë¶ˆëŸ¬ì˜¤ê¸°
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('[Address List] Page loaded');
      
      // JWT í† í° í™•ì¸
      const token = localStorage.getItem('accessToken');
      if (!token) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        location.href = '02_Login.html';
        return;
      }

      await loadAddresses();
    });
    
    // ì£¼ì†Œ ëª©ë¡ ë Œë”ë§
    async function loadAddresses() {
      const token = localStorage.getItem('accessToken');
      const container = document.getElementById('addressList');
      
      try {
        const response = await fetch(`${baseUrl}/api/v1/address/read`, {
          method: 'GET',
          credentials: 'include',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (checkAuthError(response)) return;

        if (!response.ok) {
          throw new Error('ì£¼ì†Œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }

        const data = await response.json();
        console.log('[Address List] Addresses:', data);

        if (data.success && data.data) {
          const addresses = data.data;
          
          if (addresses.length === 0) {
            container.innerHTML = '<p style="text-align: center; padding: 40px; color: var(--text-gray);">ì €ì¥ëœ ì£¼ì†Œê°€ ì—†ìŠµë‹ˆë‹¤</p>';
            return;
          }
          
          container.innerHTML = addresses.map(address => `
            <div class="address-card">
              <div class="address-header">
                <div class="address-icon">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                    <polyline points="9 22 9 12 15 12 15 22"/>
                  </svg>
                </div>
                <h4 class="address-label">${address.name || 'ì£¼ì†Œ'}</h4>
              </div>
              <div class="address-actions">
                <button class="icon-action-btn edit" onclick="location.href='10_Add_Address.html?id=${address.addressId}'">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                  </svg>
                </button>
                <button class="icon-action-btn delete" onclick="deleteAddress(${address.addressId})">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"/>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                  </svg>
                </button>
              </div>
              <p class="address-text">${address.address || ''}</p>
            </div>
          `).join('');
        }

      } catch (error) {
        console.error('[Address List] Error:', error);
        container.innerHTML = '<p style="text-align: center; padding: 40px; color: var(--text-gray);">ì£¼ì†Œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤</p>';
      }
    }
    
    // ì£¼ì†Œ ì‚­ì œ
    async function deleteAddress(addressId) {
      if (!confirm('ì´ ì£¼ì†Œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }

      const token = localStorage.getItem('accessToken');
      if (!token) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        location.href = '02_Login.html';
        return;
      }

      try {
        const response = await fetch(`${baseUrl}/api/v1/address/delete?addressId=${addressId}`, {
          method: 'DELETE',
          credentials: 'include',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (checkAuthError(response)) return;

        const result = await response.json();

        if (response.ok && result.success) {
          alert('ì£¼ì†Œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
          await loadAddresses();
        } else {
          throw new Error(result.message || 'ì£¼ì†Œ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }

      } catch (error) {
        console.error('[Address Delete] Error:', error);
        alert('ì£¼ì†Œ ì‚­ì œ ì‹¤íŒ¨: ' + error.message);
      }
    }
  </script>
</body>
</html>
