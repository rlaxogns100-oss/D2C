<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>04 Home</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="screen-label">홈</div>
  
  <div class="container">
    <!-- Restaurant Card -->
    <div class="restaurant-card">
      <!-- Image with Menu Button -->
      <div class="image-card">
        <button class="icon-btn menu-btn" id="menuBtn" onclick="toggleDropdown()">
          <svg class="chevron" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="5" r="1.5" fill="currentColor"/>
            <circle cx="12" cy="12" r="1.5" fill="currentColor"/>
            <circle cx="12" cy="19" r="1.5" fill="currentColor"/>
          </svg>
        </button>
        
        <!-- Dropdown Menu -->
        <div class="dropdown-menu" id="dropdownMenu">
          <div class="dropdown-item" onclick="location.href='07_Cart.html'">장바구니</div>
          <div class="dropdown-item" onclick="location.href='08_My_Orders.html'">주문 내역</div>
          <div class="dropdown-item" onclick="location.href='09_Address.html'">주소 관리</div>
          <div class="dropdown-item" onclick="location.href='12_Payment_Edit.html'">결제 수단 관리</div>
        </div>
        
        <!-- Pagination Dots -->
        <div class="pagination-dots">
          <span class="dot"></span>
          <span class="dot"></span>
          <span class="dot active"></span>
          <span class="dot"></span>
          <span class="dot"></span>
        </div>
      </div>
      
      <!-- Restaurant Info -->
      <div class="info-section">
        <div class="info-item rating">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
          </svg>
          <span>4.7</span>
        </div>
        
        <div class="info-item delivery">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="1" y="3" width="15" height="13" rx="2"/>
            <path d="M16 8h4l3 3v5h-3"/>
            <circle cx="5.5" cy="18.5" r="2.5"/>
            <circle cx="18.5" cy="18.5" r="2.5"/>
          </svg>
          <span>2,500원</span>
        </div>
        
        <div class="info-item time">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <path d="M12 6v6l4 2"/>
          </svg>
          <span>20분</span>
        </div>
      </div>
      
      <!-- Restaurant Name -->
      <h2 class="restaurant-name" id="restaurantName">로딩 중...</h2>
      
      <!-- Description -->
      <p class="description" id="restaurantDesc">메뉴를 불러오는 중입니다...</p>
      
      <!-- Category Tabs -->
      <div class="category-tabs" id="categoryTabs">
        <!-- 동적으로 로드됨 -->
      </div>
      
      <!-- Products Section -->
      <div class="section-header">
        <h3 id="categoryTitle">전체 <span class="item-count" id="itemCount">(0)</span></h3>
      </div>
      
      <!-- Product Grid -->
      <div class="product-grid" id="productGrid">
        <!-- 동적으로 로드됨 -->
      </div>

      <!-- Business Info -->
      <div class="business-info" style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #eee; font-size: 11px; color: #999; line-height: 1.6;">
        <div style="margin-bottom: 4px;">
          <span style="margin-right: 10px;"><strong>상호명</strong> : 제로타이핑</span>
          <span style="margin-right: 10px;"><strong>사업자등록번호</strong> : 140-29-01759</span>
          <span><strong>대표자명</strong> : 김태훈</span>
        </div>
        <div style="margin-bottom: 4px;">
          <strong>사업장주소</strong> : 경기도 용인시 수지구 현암로125번길 11, 723동 704호 (죽전동, 새터마을 아파트)
          <span style="margin-left: 10px;"><strong>연락처</strong> : 010-2808-9914</span>
        </div>
        <div>
          <span style="margin-right: 10px;"><strong>이메일</strong> : rlaxogns100@snu.ac.kr</span>
          <span style="margin-right: 10px;"><strong>통신판매업 신고번호</strong> : 신고 준비중</span>
          <span style="margin-right: 10px;"><strong>과세유형</strong> : 일반과세자</span>
          <span><strong>마지막 업데이트</strong> : -</span>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // baseUrl 처리 (로컬 파일 테스트용)
    const baseUrl = window.location.protocol === 'file:' 
      ? 'https://pizzaschool.maejang.com'
      : '';

    let allMenus = [];  // 전체 메뉴 저장
    let currentCategory = '전체';
    const OWNER_ID = 1;  // TODO: 실제로는 가게 선택 페이지에서 받아와야 함

    // 페이지 로드 시 메뉴 목록 불러오기
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('[Customer Home] Page loaded, fetching menus...');
      
      // JWT 토큰 확인 (선택사항 - 비로그인 사용자도 메뉴 조회 가능하게 할 수 있음)
      const token = localStorage.getItem('accessToken');
      
      try {
        // 메뉴 목록 가져오기
        const headers = {};
        if (token) {
          headers['Authorization'] = `Bearer ${token}`;
        }

        const menuResponse = await fetch(`${baseUrl}/api/v1/menu/read?ownerId=${OWNER_ID}`, {
          credentials: 'include',
          headers: headers
        });

        if (!menuResponse.ok) {
          throw new Error('메뉴 목록을 가져올 수 없습니다.');
        }

        const menuData = await menuResponse.json();
        console.log('[Customer Home] Menus:', menuData);

        if (menuData.success && menuData.data) {
          allMenus = menuData.data;  // 전체 메뉴 저장
          
          // 가게 이름 업데이트 (첫 번째 메뉴의 owner 정보 활용)
          if (allMenus.length > 0) {
            document.getElementById('restaurantName').textContent = 'Spicy Restaurant';  // TODO: 가게 정보 API 연동
            document.getElementById('restaurantDesc').textContent = '다양한 메뉴를 만나보세요!';
          }
          
          // 카테고리 추출 및 렌더링
          renderCategoryTabs();
          
          // 전체 메뉴 표시
          filterByCategory('전체');
        }

      } catch (error) {
        console.error('[Customer Home] Error:', error);
        document.getElementById('restaurantName').textContent = 'Spicy Restaurant';
        document.getElementById('restaurantDesc').textContent = '메뉴를 불러오는데 실패했습니다.';
        document.getElementById('productGrid').innerHTML = `
          <div style="text-align: center; padding: 60px 24px; color: var(--text-gray); grid-column: 1 / -1;">
            <p style="font-size: 16px; margin-bottom: 12px;">메뉴를 불러올 수 없습니다</p>
            <p style="font-size: 14px;">${error.message}</p>
          </div>
        `;
      }
    });

    // 카테고리 탭 렌더링
    function renderCategoryTabs() {
      const categories = ['전체', ...new Set(allMenus.map(m => m.category).filter(c => c))];
      const tabsContainer = document.getElementById('categoryTabs');
      tabsContainer.innerHTML = categories.map(cat => 
        `<button class="tab-btn ${cat === currentCategory ? 'active' : ''}" onclick="filterByCategory('${cat}')">${cat}</button>`
      ).join('');
    }

    // 카테고리별 필터링
    function filterByCategory(category) {
      currentCategory = category;
      
      // 탭 active 상태 변경
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent.trim() === category) {
          btn.classList.add('active');
        }
      });
      
      // 필터링
      const filtered = category === '전체' 
        ? allMenus 
        : allMenus.filter(menu => menu.category === category);
      
      // 제목 업데이트
      document.getElementById('categoryTitle').innerHTML = `${category} <span class="item-count" id="itemCount">(${filtered.length})</span>`;
      
      // 메뉴 리스트 렌더링
      renderMenuList(filtered);
    }

    // 메뉴 리스트 렌더링
    function renderMenuList(menus) {
      const productGrid = document.getElementById('productGrid');

      if (menus.length === 0) {
        productGrid.innerHTML = `
          <div style="text-align: center; padding: 60px 24px; color: var(--text-gray); grid-column: 1 / -1;">
            <p style="font-size: 16px; margin-bottom: 12px;">등록된 메뉴가 없습니다</p>
          </div>
        `;
        return;
      }

      productGrid.innerHTML = menus.map(menu => {
        const imgStyle = menu.picture 
          ? `background-image: url('${menu.picture}'); background-size: cover; background-position: center;` 
          : 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);';
        
        return `
          <div class="product-card" onclick="viewMenuDetail(${menu.menuId})" style="cursor: pointer;">
            <div class="product-image" style="${imgStyle}"></div>
            <div class="product-info">
              <h4 class="product-name">${menu.menuName}</h4>
              <p class="product-restaurant">${menu.description || 'Spicy Restaurant'}</p>
              <div class="product-footer">
                <span class="product-price">${menu.price.toLocaleString()}원</span>
                <button class="add-btn" onclick="event.stopPropagation(); viewMenuDetail(${menu.menuId})">+</button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // 메뉴 상세 페이지로 이동
    function viewMenuDetail(menuId) {
      location.href = `06_Food_Details.html?menuId=${menuId}`;
    }

    // 드롭다운 메뉴 토글
    function toggleDropdown() {
      const menu = document.getElementById('dropdownMenu');
      const btn = document.getElementById('menuBtn');
      
      menu.classList.toggle('active');
      btn.classList.toggle('active');
    }
    
    // 메뉴 외부 클릭 시 닫기
    document.addEventListener('click', function(event) {
      const menu = document.getElementById('dropdownMenu');
      const btn = document.getElementById('menuBtn');
      
      if (!menu.contains(event.target) && !btn.contains(event.target)) {
        menu.classList.remove('active');
        btn.classList.remove('active');
      }
    });
  </script>
</body>
</html>
